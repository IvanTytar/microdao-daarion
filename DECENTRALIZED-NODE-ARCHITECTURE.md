# üåê –î–µ—Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –º–µ—Ä–µ–∂–∞ –Ω–æ–¥ - –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è

**–î–∞—Ç–∞:** 2025-11-23  
**–í–µ—Ä—Å—ñ—è:** 2.0.0  
**–°—Ç–∞—Ç—É—Å:** üéØ Production Architecture

---

## üéØ –ú–µ—Ç–∞

–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ–≤–Ω—ñ—Å—Ç—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω—É —Å–∏—Å—Ç–µ–º—É –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –Ω–æ–¥ –¥–æ –¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ—ó –º–µ—Ä–µ–∂—ñ —à—Ç—É—á–Ω–æ–≥–æ —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –≤—Ç—Ä—É—á–∞–Ω–Ω—è.

---

## üèóÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –º–µ—Ä–µ–∂—ñ

### –ü–æ—Ç–æ—á–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 DAARION AI Network                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                          ‚îÇ
‚îÇ  –ù–û–î–ê1 (Hetzner) ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îÇ
‚îÇ  144.76.224.179                      ‚îÇ                  ‚îÇ
‚îÇ  ‚îú‚îÄ Node Registry (9205)             ‚îÇ                  ‚îÇ
‚îÇ  ‚îú‚îÄ NATS JetStream (4222)            ‚îÇ                  ‚îÇ
‚îÇ  ‚îú‚îÄ DAGI Router (9102)               ‚îÇ  Discovery       ‚îÇ
‚îÇ  ‚îî‚îÄ Gateway (9300)                   ‚îÇ  & Heartbeat     ‚îÇ
‚îÇ                                      ‚îÇ                  ‚îÇ
‚îÇ  –ù–û–î–ê2 (MacBook M4 Max) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îÇ
‚îÇ  192.168.1.33 (local)                                   ‚îÇ
‚îÇ  ‚îú‚îÄ Development Node                                    ‚îÇ
‚îÇ  ‚îú‚îÄ 50 DAARION Agents                                   ‚îÇ
‚îÇ  ‚îî‚îÄ 8 AI Models                                         ‚îÇ
‚îÇ                                                          ‚îÇ
‚îÇ  –ù–û–î–ê3-N (Future) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îÇ
‚îÇ  Any location                        ‚îÇ                  ‚îÇ
‚îÇ  ‚îî‚îÄ Auto-registration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ —Å–∏—Å—Ç–µ–º–∏

### 1. Node Registry Service (–í–∂–µ —ñ—Å–Ω—É—î!)

**–ú—ñ—Å—Ü–µ:** –ù–û–î–ê1 (144.76.224.179:9205)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–∏–π (–ø–æ—Ç—Ä—ñ–±–Ω–∞ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—è API)

**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:**
- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π —Ä–µ—î—Å—Ç—Ä –≤—Å—ñ—Ö –Ω–æ–¥
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–æ–≤–∏—Ö –Ω–æ–¥
- Heartbeat tracking (keep-alive)
- Node discovery

**–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö:**
```sql
-- nodes table
node_id           VARCHAR(255)  -- –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –Ω–æ–¥–∏
node_name         VARCHAR(255)  -- –õ—é–¥—Å—å–∫–µ —ñ–º'—è
ip_address        INET          -- –ü—É–±–ª—ñ—á–Ω–∞ IP
local_ip          INET          -- –õ–æ–∫–∞–ª—å–Ω–∞ IP
status            VARCHAR(50)   -- online, offline, degraded
last_heartbeat    TIMESTAMP     -- –û—Å—Ç–∞–Ω–Ω—ñ–π heartbeat
capabilities      JSONB         -- GPU, CPU, RAM, –º–æ–¥–µ–ª—ñ
```

**API Endpoints:**
```bash
POST /api/v1/nodes/register     # –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–æ–≤–æ—ó –Ω–æ–¥–∏
POST /api/v1/nodes/heartbeat    # Heartbeat (keep-alive)
GET  /api/v1/nodes              # –°–ø–∏—Å–æ–∫ –≤—Å—ñ—Ö –Ω–æ–¥
GET  /api/v1/nodes/{node_id}    # –Ü–Ω—Ñ–æ –ø—Ä–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É –Ω–æ–¥—É
GET  /api/v1/nodes/discover     # –ó–Ω–∞–π—Ç–∏ –Ω–æ–¥–∏ –∑ –ø–µ–≤–Ω–∏–º–∏ capabilities
```

---

### 2. Bootstrap Agent (–ê–≤—Ç–æ-—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è)

**–§–∞–π–ª:** `tools/dagi_node_agent/bootstrap.py`  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –Ü—Å–Ω—É—î, –ø–æ—Ç—Ä—ñ–±–Ω–µ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è

**–Ø–∫ –ø—Ä–∞—Ü—é—î:**

```python
# –ó–∞–ø—É—Å–∫ –Ω–∞ –Ω–æ–≤—ñ–π –Ω–æ–¥—ñ
python3 -m tools.dagi_node_agent.bootstrap \
  --role production-node \
  --labels gpu,cpu,ollama \
  --registry-url http://144.76.224.179:9205
```

**–©–æ —Ä–æ–±–∏—Ç—å:**
1. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∑–Ω–∞—á–∞—î hostname, IP
2. ‚úÖ –ì–µ–Ω–µ—Ä—É—î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π node_id
3. ‚úÖ –ó–±–∏—Ä–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Å–∏—Å—Ç–µ–º—É (CPU, RAM, GPU)
4. ‚úÖ –†–µ—î—Å—Ç—Ä—É—î—Ç—å—Å—è –≤ Node Registry
5. ‚úÖ –ó–±–µ—Ä—ñ–≥–∞—î node_id –ª–æ–∫–∞–ª—å–Ω–æ
6. ‚úÖ –ó–∞–ø—É—Å–∫–∞—î heartbeat loop

---

### 3. Heartbeat Service (Keep-Alive)

**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:** –ü—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ Registry

**–ú–µ—Ö–∞–Ω—ñ–∑–º:**
```python
# –ö–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î heartbeat
while True:
    await send_heartbeat(node_id, metrics)
    await asyncio.sleep(30)
```

**–ú–µ—Ç—Ä–∏–∫–∏ —â–æ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—é—Ç—å—Å—è:**
- CPU usage %
- RAM usage %
- GPU usage % (—è–∫—â–æ —î)
- Disk usage %
- –ê–∫—Ç–∏–≤–Ω—ñ —Å–µ—Ä–≤—ñ—Å–∏
- –ö—ñ–ª—å–∫—ñ—Å—Ç—å –∞–≥–µ–Ω—Ç—ñ–≤
- –°—Ç–∞—Ç—É—Å –º–æ–¥–µ–ª–µ–π

---

### 4. Discovery Service (–ü–æ—à—É–∫ –Ω–æ–¥)

**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:** –ó–Ω–∞–π—Ç–∏ –Ω–æ–¥—É –∑ –ø–æ—Ç—Ä—ñ–±–Ω–∏–º–∏ capabilities

**API Query:**
```bash
# –ó–Ω–∞–π—Ç–∏ –Ω–æ–¥—É –∑ GPU
GET /api/v1/nodes/discover?capability=gpu&status=online

# –ó–Ω–∞–π—Ç–∏ –Ω–æ–¥—É –∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—é –º–æ–¥–µ–ª–ª—é
GET /api/v1/nodes/discover?model=deepseek-r1:70b

# –ó–Ω–∞–π—Ç–∏ –Ω–∞–π–±–ª–∏–∂—á—É –Ω–æ–¥—É
GET /api/v1/nodes/discover?latency=min&region=europe
```

**Response:**
```json
{
  "nodes": [
    {
      "node_id": "node-1-hetzner",
      "ip_address": "144.76.224.179",
      "latency_ms": 45,
      "capabilities": {
        "gpu": "NVIDIA RTX 4000",
        "models": ["qwen3:8b", "mistral:7b"]
      }
    }
  ]
}
```

---

## üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –Ω–æ–¥–∏

### –°—Ü–µ–Ω–∞—Ä—ñ–π: –î–æ–¥–∞–≤–∞–Ω–Ω—è –ù–û–î–ê3

#### –ö—Ä–æ–∫ 1: –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ –Ω–æ–≤—ñ–π –Ω–æ–¥—ñ
```bash
# –ù–∞ –ù–û–î–ê3
git clone git@github.com:IvanTytar/microdao-daarion.git
cd microdao-daarion
pip install -r requirements.txt
```

#### –ö—Ä–æ–∫ 2: –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è (–æ–¥–∏–Ω —Ñ–∞–π–ª)
```bash
# –°—Ç–≤–æ—Ä–∏—Ç–∏ .env —Ñ–∞–π–ª
cat > .env << EOF
# Node Registry URL
NODE_REGISTRY_URL=http://144.76.224.179:9205

# NATS –¥–ª—è –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó
NATS_URL=nats://144.76.224.179:4222

# –†–æ–ª—å –Ω–æ–¥–∏
NODE_ROLE=worker-node
NODE_LABELS=gpu,inference,home

# Ollama (—è–∫—â–æ —î)
OLLAMA_BASE_URL=http://localhost:11434
EOF
```

#### –ö—Ä–æ–∫ 3: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–∏ bootstrap
python3 -m tools.dagi_node_agent.bootstrap --auto
```

**–©–æ –≤—ñ–¥–±—É–¥–µ—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:**
1. ‚úÖ –í–∏–∑–Ω–∞—á–∏—Ç—å hostname —Ç–∞ IP
2. ‚úÖ –ó–≥–µ–Ω–µ—Ä—É—î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π node_id
3. ‚úÖ –ó—Å–∫–∞–Ω—É—î —Å–∏—Å—Ç–µ–º—É (CPU, RAM, GPU, –¥–∏—Å–∫)
4. ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å –Ω–∞—è–≤–Ω—ñ—Å—Ç—å Ollama —Ç–∞ –º–æ–¥–µ–ª–µ–π
5. ‚úÖ –ó–∞—Ä–µ—î—Å—Ç—Ä—É—î—Ç—å—Å—è –≤ Node Registry
6. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å heartbeat service
7. ‚úÖ –°—Ç–∞–Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ—é –≤ –º–µ—Ä–µ–∂—ñ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥

#### –ö—Ä–æ–∫ 4: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
```bash
# –ù–∞ –±—É–¥—å-—è–∫—ñ–π –Ω–æ–¥—ñ
curl http://144.76.224.179:9205/api/v1/nodes

# –ü–æ–±–∞—á–∏—Ç–µ –ù–û–î–ê3 –≤ —Å–ø–∏—Å–∫—É!
```

---

## üîê –ë–µ–∑–ø–µ–∫–∞ —Ç–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è

### –†—ñ–≤–µ–Ω—å 1: API Key (–ë–∞–∑–æ–≤–∏–π)
```bash
# –ü—Ä–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è API key
NODE_API_KEY=sk-node-abc123xyz

# –í—Å—ñ –∑–∞–ø–∏—Ç–∏ –¥–æ Registry –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –∫–ª—é—á
curl -H "Authorization: Bearer $NODE_API_KEY" \
  http://144.76.224.179:9205/api/v1/nodes
```

### –†—ñ–≤–µ–Ω—å 2: mTLS (Mutual TLS)
```bash
# –ö–æ–∂–Ω–∞ –Ω–æ–¥–∞ –º–∞—î —Å–≤—ñ–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç
NODE_CERT=/etc/dagi/certs/node.crt
NODE_KEY=/etc/dagi/certs/node.key
CA_CERT=/etc/dagi/certs/ca.crt

# –í—Å—ñ –∑'—î–¥–Ω–∞–Ω–Ω—è —á–µ—Ä–µ–∑ TLS
```

### –†—ñ–≤–µ–Ω—å 3: Whitelist (IP –∞–±–æ node_id)
```python
# –í Node Registry
ALLOWED_NODES = [
    "node-1-hetzner",
    "node-2-macbook",
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞—é—Ç—å—Å—è –ø—ñ—Å–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
]
```

---

## üåç –¢–æ–ø–æ–ª–æ–≥—ñ—ó –º–µ—Ä–µ–∂—ñ

### –¢–æ–ø–æ–ª–æ–≥—ñ—è 1: –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ (–ø–æ—Ç–æ—á–Ω–∞)
```
          –ù–û–î–ê1 (Registry)
         /    |    \
       /      |      \
   –ù–û–î–ê2   –ù–û–î–ê3   –ù–û–î–ê4
```

**–ü–ª—é—Å–∏:**
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞
- ‚úÖ –û–¥–∏–Ω point of truth
- ‚úÖ –õ–µ–≥–∫–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è

**–ú—ñ–Ω—É—Å–∏:**
- ‚ö†Ô∏è Single point of failure
- ‚ö†Ô∏è Bottleneck –ø—Ä–∏ –≤–µ–ª–∏–∫—ñ–π –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –Ω–æ–¥

### –¢–æ–ø–æ–ª–æ–≥—ñ—è 2: –§–µ–¥–µ—Ä–∞—Ç–∏–≤–Ω–∞ (–º–∞–π–±—É—Ç–Ω—î)
```
    –ù–û–î–ê1 (Registry-EU)  ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫  –ù–û–î–ê5 (Registry-US)
      /  |  \                      /  |  \
  –ù–û–î–ê2 3  4                   –ù–û–î–ê6 7  8
```

**–ü–ª—é—Å–∏:**
- ‚úÖ –í—ñ–¥–º–æ–≤–æ—Å—Ç—ñ–π–∫—ñ—Å—Ç—å
- ‚úÖ –ì–µ–æ–≥—Ä–∞—Ñ—ñ—á–Ω–∞ –±–ª–∏–∑—å–∫—ñ—Å—Ç—å
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å

**–ú—ñ–Ω—É—Å–∏:**
- ‚ö†Ô∏è –°–∫–ª–∞–¥–Ω—ñ—à–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è
- ‚ö†Ô∏è Eventual consistency

### –¢–æ–ø–æ–ª–æ–≥—ñ—è 3: P2P (–ø–æ–≤–Ω–∞ –¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–∞—Ü—ñ—è)
```
 –ù–û–î–ê1 ‚óÑ‚îÄ‚îÄ‚ñ∫ –ù–û–î–ê2
   ‚ñ≤ \       / ‚ñ≤
   ‚îÇ   \   /   ‚îÇ
   ‚îÇ     ‚óÑ     ‚îÇ
   ‚îî‚îÄ‚ñ∫ –ù–û–î–ê3 ‚óÑ‚îÄ‚îò
```

**–ü–ª—é—Å–∏:**
- ‚úÖ –ü–æ–≤–Ω–∞ –¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–∞—Ü—ñ—è
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –≤—ñ–¥–º–æ–≤–æ—Å—Ç—ñ–π–∫—ñ—Å—Ç—å
- ‚úÖ –ù–µ–º–∞—î central authority

**–ú—ñ–Ω—É—Å–∏:**
- ‚ö†Ô∏è –°–∫–ª–∞–¥–Ω–∞ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—è
- ‚ö†Ô∏è Consensus –ø—Ä–æ—Ç–æ–∫–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ

---

## üì° –ü—Ä–æ—Ç–æ–∫–æ–ª–∏ –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó

### 1. HTTP/REST (–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Ç–∞ discovery)
```
–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è, heartbeat, queries
–ü—Ä–æ—Ç–æ–∫–æ–ª: HTTP/HTTPS
–ü–æ—Ä—Ç: 9205
```

### 2. NATS JetStream (Messaging)
```
–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, events
–ü—Ä–æ—Ç–æ–∫–æ–ª: NATS
–ü–æ—Ä—Ç: 4222
Topics:
  - node.{node_id}.events
  - node.{node_id}.tasks
  - system.broadcast
```

### 3. gRPC (High-performance calls)
```
–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: –®–≤–∏–¥–∫—ñ –∑–∞–ø–∏—Ç–∏ –º—ñ–∂ –Ω–æ–¥–∞–º–∏
–ü—Ä–æ—Ç–æ–∫–æ–ª: gRPC/HTTP2
–ü–æ—Ä—Ç: 9106 (–º–∞–π–±—É—Ç–Ω—î)
```

### 4. WebSocket (Real-time)
```
–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: Real-time dashboard, monitoring
–ü—Ä–æ—Ç–æ–∫–æ–ª: WebSocket
–ü–æ—Ä—Ç: 9107 (–º–∞–π–±—É—Ç–Ω—î)
```

---

## üîÑ –ñ–∏—Ç—Ç—î–≤–∏–π —Ü–∏–∫–ª –Ω–æ–¥–∏

### 1. Registration (–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è)
```
–ù–û–î–ê3 ‚Üí POST /api/v1/nodes/register ‚Üí Node Registry
Response: {node_id, api_key, config}
```

### 2. Active (–ü—Ä–∞—Ü—é—î)
```
–ù–û–î–ê3 ‚Üí POST /api/v1/nodes/heartbeat (every 30s) ‚Üí Registry
Registry ‚Üí Marks node as "online"
```

### 3. Degraded (–ü—Ä–æ–±–ª–µ–º–∏)
```
Heartbeat timeout > 90s
Registry ‚Üí Marks node as "degraded"
Alert sent to admin
```

### 4. Offline (–í—ñ–¥–∫–ª—é—á–µ–Ω–∞)
```
Heartbeat timeout > 5min
Registry ‚Üí Marks node as "offline"
Node removed from active routing
```

### 5. Deregistration (–í–∏–¥–∞–ª–µ–Ω–Ω—è)
```
–ù–û–î–ê3 ‚Üí DELETE /api/v1/nodes/{node_id} ‚Üí Registry
Registry ‚Üí Removes node from database
```

---

## üõ†Ô∏è –ü—Ä–∞–∫—Ç–∏—á–Ω–∞ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—è

### –§–∞–π–ª 1: `bootstrap.py` (–ü–æ–∫—Ä–∞—â–µ–Ω–∏–π)
```python
#!/usr/bin/env python3
"""
–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–æ–¥–∏ –≤ DAARION Network
"""
import socket
import platform
import psutil
import requests
import uuid
from pathlib import Path

class NodeBootstrap:
    def __init__(self, registry_url):
        self.registry_url = registry_url
        self.node_id = self.generate_node_id()
    
    def generate_node_id(self):
        """–ì–µ–Ω–µ—Ä—É—î —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π node_id"""
        hostname = socket.gethostname()
        # –Ø–∫—â–æ —î –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π ID - –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –π–æ–≥–æ
        node_id_file = Path.home() / ".dagi" / "node_id"
        if node_id_file.exists():
            return node_id_file.read_text().strip()
        
        # –Ü–Ω–∞–∫—à–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π
        short_uuid = str(uuid.uuid4())[:8]
        node_id = f"node-{hostname}-{short_uuid}"
        
        # –ó–±–µ—Ä–µ–≥—Ç–∏ –¥–ª—è –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
        node_id_file.parent.mkdir(parents=True, exist_ok=True)
        node_id_file.write_text(node_id)
        
        return node_id
    
    def collect_capabilities(self):
        """–ó–±–∏—Ä–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Å–∏—Å—Ç–µ–º—É"""
        capabilities = {
            "hostname": socket.gethostname(),
            "ip_address": self.get_public_ip(),
            "local_ip": self.get_local_ip(),
            "os": platform.system(),
            "os_version": platform.version(),
            "cpu_cores": psutil.cpu_count(),
            "ram_gb": round(psutil.virtual_memory().total / (1024**3), 2),
            "disk_gb": round(psutil.disk_usage('/').total / (1024**3), 2),
            "gpu": self.detect_gpu(),
            "ollama": self.check_ollama(),
        }
        return capabilities
    
    def register(self):
        """–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –≤ Node Registry"""
        payload = {
            "node_id": self.node_id,
            "capabilities": self.collect_capabilities(),
            "status": "online"
        }
        
        response = requests.post(
            f"{self.registry_url}/api/v1/nodes/register",
            json=payload,
            timeout=10
        )
        response.raise_for_status()
        
        return response.json()
    
    def start_heartbeat(self):
        """–ó–∞–ø—É—Å–∫–∞—î heartbeat loop"""
        import asyncio
        asyncio.run(self.heartbeat_loop())
    
    async def heartbeat_loop(self):
        """–ë–µ–∑–∫—ñ–Ω–µ—á–Ω–∏–π loop heartbeat"""
        while True:
            try:
                metrics = self.collect_metrics()
                requests.post(
                    f"{self.registry_url}/api/v1/nodes/heartbeat",
                    json={"node_id": self.node_id, "metrics": metrics},
                    timeout=5
                )
            except Exception as e:
                print(f"Heartbeat failed: {e}")
            
            await asyncio.sleep(30)
    
    # ... (—ñ–Ω—à—ñ –º–µ—Ç–æ–¥–∏)

if __name__ == "__main__":
    bootstrap = NodeBootstrap("http://144.76.224.179:9205")
    print(f"üîß Registering node: {bootstrap.node_id}")
    
    result = bootstrap.register()
    print(f"‚úÖ Registered successfully!")
    print(f"   Node ID: {result['node_id']}")
    print(f"   API Key: {result['api_key']}")
    
    print("üíì Starting heartbeat...")
    bootstrap.start_heartbeat()
```

### –§–∞–π–ª 2: `node_discovery.py` (–ü–æ—à—É–∫ –Ω–æ–¥)
```python
"""
–ü–æ—à—É–∫ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –Ω–æ–¥ –≤ –º–µ—Ä–µ–∂—ñ
"""
import requests
from typing import List, Dict, Optional

class NodeDiscovery:
    def __init__(self, registry_url):
        self.registry_url = registry_url
    
    def find_nodes(
        self, 
        role: Optional[str] = None,
        capability: Optional[str] = None,
        status: str = "online"
    ) -> List[Dict]:
        """–ó–Ω–∞–π—Ç–∏ –Ω–æ–¥–∏ –∑–∞ –∫—Ä–∏—Ç–µ—Ä—ñ—è–º–∏"""
        params = {"status": status}
        if role:
            params["role"] = role
        if capability:
            params["capability"] = capability
        
        response = requests.get(
            f"{self.registry_url}/api/v1/nodes/discover",
            params=params
        )
        response.raise_for_status()
        
        return response.json()["nodes"]
    
    def find_best_node_for_model(self, model_name: str) -> Optional[Dict]:
        """–ó–Ω–∞–π—Ç–∏ –Ω–∞–π–∫—Ä–∞—â—É –Ω–æ–¥—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó –º–æ–¥–µ–ª—ñ"""
        nodes = self.find_nodes(capability="ollama")
        
        for node in nodes:
            if model_name in node["capabilities"].get("models", []):
                return node
        
        return None
    
    def get_nearest_node(self, location: str = "auto") -> Dict:
        """–ó–Ω–∞–π—Ç–∏ –Ω–∞–π–±–ª–∏–∂—á—É –Ω–æ–¥—É"""
        response = requests.get(
            f"{self.registry_url}/api/v1/nodes/discover",
            params={"nearest": location}
        )
        response.raise_for_status()
        
        return response.json()["nodes"][0]

# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
discovery = NodeDiscovery("http://144.76.224.179:9205")

# –ó–Ω–∞–π—Ç–∏ –≤—Å—ñ –Ω–æ–¥–∏ –∑ GPU
gpu_nodes = discovery.find_nodes(capability="gpu")
print(f"Found {len(gpu_nodes)} nodes with GPU")

# –ó–Ω–∞–π—Ç–∏ –Ω–æ–¥—É –∑ deepseek-r1:70b
node = discovery.find_best_node_for_model("deepseek-r1:70b")
if node:
    print(f"Model available on: {node['node_name']}")
```

---

## üéØ –ü–µ—Ä–µ–≤–∞–≥–∏ —Ü—ñ—î—ó –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏

### –î–ª—è —Ä–æ–∑—Ä–æ–±–Ω–∏–∫—ñ–≤
- ‚úÖ **Plug and Play** - –¥–æ–¥–∞–ª–∏ –Ω–æ–¥—É –∑–∞ 5 —Ö–≤–∏–ª–∏–Ω
- ‚úÖ **–ù—É–ª—å–æ–≤–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è** - –≤—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
- ‚úÖ **Discovery API** - –ª–µ–≥–∫–æ –∑–Ω–∞–π—Ç–∏ –ø–æ—Ç—Ä—ñ–±–Ω—É –Ω–æ–¥—É

### –î–ª—è —Å–∏—Å—Ç–µ–º–∏
- ‚úÖ **Fault tolerance** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏—è–≤–ª–µ–Ω–Ω—è –∑–±–æ—ó–≤
- ‚úÖ **Load balancing** - —Ä–æ–∑–ø–æ–¥—ñ–ª –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
- ‚úÖ **Horizontal scaling** - –¥–æ–¥–∞–≤–∞–π —Å–∫—ñ–ª—å–∫–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –Ω–æ–¥

### –î–ª—è –±—ñ–∑–Ω–µ—Å—É
- ‚úÖ **–®–≤–∏–¥–∫–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è** - –≤—ñ–¥ 2 –¥–æ 1000 –Ω–æ–¥
- ‚úÖ **–ì–µ–æ–≥—Ä–∞—Ñ—ñ—á–Ω–µ —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–Ω—è** - –Ω–æ–¥–∏ –ø–æ –≤—Å—å–æ–º—É —Å–≤—ñ—Ç—É
- ‚úÖ **Cost optimization** - –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤ –ø–æ –ø–æ—Ç—Ä–µ–±—ñ

---

## üìà Roadmap

### Phase 1: –ë–∞–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å (–ó–ê–†–ê–ó)
- [x] Node Registry Service infrastructure
- [ ] –Ü–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—è Node Registry API
- [ ] Bootstrap agent –ø–æ–∫—Ä–∞—â–µ–Ω–∏–π
- [ ] Heartbeat service
- [ ] Discovery API

### Phase 2: –ë–µ–∑–ø–µ–∫–∞ —Ç–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
- [ ] API key authentication
- [ ] mTLS certificates
- [ ] Prometheus metrics
- [ ] Grafana dashboards
- [ ] Alert system

### Phase 3: –§–µ–¥–µ—Ä–∞—Ü—ñ—è
- [ ] Multi-region registries
- [ ] Registry replication
- [ ] Geographic routing
- [ ] Latency optimization

### Phase 4: –ü–æ–≤–Ω–∞ –¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–∞—Ü—ñ—è
- [ ] P2P discovery (DHT)
- [ ] Consensus protocol
- [ ] Blockchain registry (optional)
- [ ] Zero-knowledge proofs

---

## ‚úÖ –©–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑—Ä–æ–±–∏—Ç–∏ –ó–ê–†–ê–ó

### 1. –ó–∞–≤–µ—Ä—à–∏—Ç–∏ Node Registry API
```bash
# –§–∞–π–ª: services/node-registry/app/main.py
# –Ü–º–ø–ª–µ–º–µ–Ω—Ç—É–≤–∞—Ç–∏ endpoints:
POST /api/v1/nodes/register
POST /api/v1/nodes/heartbeat
GET  /api/v1/nodes
GET  /api/v1/nodes/{node_id}
GET  /api/v1/nodes/discover
```

### 2. –ü–æ–∫—Ä–∞—â–∏—Ç–∏ Bootstrap Agent
```bash
# –§–∞–π–ª: tools/dagi_node_agent/bootstrap.py
# –î–æ–¥–∞—Ç–∏:
- Auto-detection capabilities
- Ollama models scanning
- GPU detection (NVIDIA, Apple Silicon)
- Persistent node_id storage
```

### 3. –°—Ç–≤–æ—Ä–∏—Ç–∏ Frontend –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É
```bash
# –î–æ–¥–∞—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤ React:
/nodes/registry
- –°–ø–∏—Å–æ–∫ –≤—Å—ñ—Ö –Ω–æ–¥
- –°—Ç–∞—Ç—É—Å (online/offline)
- Capabilities
- Real-time heartbeat
```

---

## üéØ –í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –≤–∞—à–µ –ø–∏—Ç–∞–Ω–Ω—è

### –ß–∏ –º–æ–∂–ª–∏–≤–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–¥?

**‚úÖ –¢–ê–ö! –¶–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –º–æ–∂–ª–∏–≤–æ —ñ –≤–∂–µ —á–∞—Å—Ç–∫–æ–≤–æ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ!**

**–©–æ –≤–∂–µ —î:**
- ‚úÖ Node Registry Service (infra—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞)
- ‚úÖ Bootstrap Agent (–±–∞–∑–æ–≤–∞ –≤–µ—Ä—Å—ñ—è)
- ‚úÖ Database schema –¥–ª—è –Ω–æ–¥
- ‚úÖ Docker –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è

**–©–æ —Ç—Ä–µ–±–∞:**
- üîß –ó–∞–≤–µ—Ä—à–∏—Ç–∏ Node Registry API (1-2 –¥–Ω—ñ)
- üîß –ü–æ–∫—Ä–∞—â–∏—Ç–∏ Bootstrap Agent (1 –¥–µ–Ω—å)
- üîß –î–æ–¥–∞—Ç–∏ heartbeat service (1 –¥–µ–Ω—å)
- üîß –°—Ç–≤–æ—Ä–∏—Ç–∏ Discovery API (1 –¥–µ–Ω—å)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```bash
# –ù–∞ –±—É–¥—å-—è–∫—ñ–π –Ω–æ–≤—ñ–π –Ω–æ–¥—ñ –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞—î—Ç–µ:
./scripts/join-network.sh

# –Ü –Ω–æ–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ:
# 1. –†–µ—î—Å—Ç—Ä—É—î—Ç—å—Å—è
# 2. –ü–æ—á–∏–Ω–∞—î heartbeat
# 3. –°—Ç–∞—î –¥–æ—Å—Ç—É–ø–Ω–æ—é –≤ –º–µ—Ä–µ–∂—ñ
# 4. –ó'—è–≤–ª—è—î—Ç—å—Å—è –≤ dashboard
```

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞, –∑–∞–ª–∏—à–∏–ª–∞—Å—å —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—è!**  
**–ß–∞—Å–æ–≤–∞ –æ—Ü—ñ–Ω–∫–∞:** 4-5 –¥–Ω—ñ–≤ —Ä–æ–∑—Ä–æ–±–∫–∏  
**–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å:** –°–µ—Ä–µ–¥–Ω—è (Node Registry API + Bootstrap –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è)

**–ö–æ–ª–∏ –±—É–¥–µ –≥–æ—Ç–æ–≤–æ - —É –≤–∞—Å –±—É–¥–µ plug-and-play –º–µ—Ä–µ–∂–∞ —à—Ç—É—á–Ω–æ–≥–æ —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É! üöÄ**


