# –°—Ç–∞—Ä—Ç–æ–≤–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç—É (24.11.2025)

–¶–µ–π –¥–æ–∫—É–º–µ–Ω—Ç –º–æ–∂–Ω–∞ –∫–æ–ø—ñ—é–≤–∞—Ç–∏ —è–∫ –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–æ–º—Ç –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ –Ω–æ–≤–æ–≥–æ –¥—ñ–∞–ª–æ–≥—É, —â–æ–± –æ–¥—Ä–∞–∑—É –º–∞—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–∏—Ö –∞–≥–µ–Ω—Ç—ñ–≤.

## üîä –ì–æ–ª–æ—Å (STT/TTS)
- STT —Å–µ—Ä–≤—ñ—Å `dagi-stt-service` –ø–µ—Ä–µ–±—É–¥–æ–≤–∞–Ω–∏–π –∑ Whisper (`openai-whisper==20231117`, `torch==2.1.0`, `numpy<2`) —Ç–∞ –ø—Ä–∞—Ü—é—î –Ω–∞ `http://172.21.0.19:8895/api/stt/upload`.
- –¢–µ—Å—Ç —á–µ—Ä–µ–∑ `curl -F file=@/tmp/test.wav` –ø–æ–≤–µ—Ä—Ç–∞—î 200 OK (pipeline —Ä–æ–±–æ—á–∏–π).
- Gateway (`telegram-gateway/app/router_handler.py`) –Ω–∞–¥—Å–∏–ª–∞—î –≥–æ–ª–æ—Å–æ–≤—ñ –Ω–∞ `/api/stt/upload` –∑ –ø–æ–ª–µ–º `file`.
- –ù–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫: –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –∂–∏–≤–∏–º –≥–æ–ª–æ—Å–æ–≤–∏–º —É –±—É–¥—å-—è–∫–æ–≥–æ Telegram-–±–æ—Ç–∞; TTS –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ —â–µ –Ω–µ –≤–º–∏–∫–∞–ª–∏—Å—å.

## üì∏ –§–æ—Ç–æ (vision)
- `_handle_photo` —Ç–µ–ø–µ—Ä –≤–∏—Ç—è–≥—É—î `file_id` ‚Üí `file_url` —á–µ—Ä–µ–∑ Telegram Bot API —Ç–∞ —à–ª–µ –≤ Router.
- –£ Router –¥–æ–¥–∞–Ω–æ –ø—Ä–æ—Ñ—ñ–ª—å `specialist_vision_8b` (alias –Ω–∞ `qwen3-vl:8b`) —ñ –≤ metadata gateway –ø–µ—Ä–µ–¥–∞—î `provider: "llm_specialist_vision_8b"`.
- –ü–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏, —â–æ Router –ø–æ–≤–µ—Ä—Ç–∞—î —Ä–µ–∞–ª—å–Ω–∏–π –æ–ø–∏—Å (–±–µ–∑ fallback ¬´–Ω–µ –º–æ–∂—É –æ–±—Ä–æ–±–∏—Ç–∏¬ª) ‚Äî –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ vision-–º–æ–¥–µ–ª—ñ.

## üì° Telegram Gateway
- –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∏–π –æ—Å—Ç–∞–Ω–Ω—å–æ—é –≤–µ—Ä—Å—ñ—î—é (—É—Å—ñ 9 –±–æ—Ç—ñ–≤ —É polling).
- –ì–æ–ª–æ—Å–æ–≤—ñ/—Ñ–æ—Ç–æ —Ç–µ–ø–µ—Ä –ø—Ä–æ—Ö–æ–¥—è—Ç—å —É NATS -> Router –±–µ–∑ 500 –≤ gateway.
- –ü–æ—Å—Ç—ñ–π–Ω–µ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è `nats: not a JetStream message` –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–µ (acks –≤–∏–∫–ª–∏–∫–∞—é—Ç—å—Å—è –Ω–∞ –∑–≤–∏—á–∞–π–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è—Ö, –º–æ–∂–Ω–∞ –≤—ñ–¥–∫–ª–∞—Å—Ç–∏ —Ñ—ñ–∫—Å).

## ‚úÖ –©–æ –≤–∂–µ –∑—Ä–æ–±–ª–µ–Ω–æ
- STT –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–±—É–¥–æ–≤–∞–Ω–æ, health OK.
- `_handle_photo` –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–æ –Ω–∞ —Ä–æ–±–æ—á–∏–π pipeline.
- Router –∑–∞–ª–∏—à–∏–≤—Å—è –Ω–∞ Dev-–∫–æ–Ω—Ñ—ñ–∑—ñ, –∞–ª–µ –º–∞—î –ø—Ä–æ—Ñ—ñ–ª—å `llm_specialist_vision_8b`.

## ‚è≠Ô∏è –©–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è —Å—Ç–∞—Ä—Ç—É –Ω–æ–≤–æ–≥–æ —á–∞—Ç—É
1. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≥–æ–ª–æ—Å–æ–≤–µ –≤ –±—É–¥—å-—è–∫–æ–≥–æ –±–æ—Ç–∞, –ø–µ—Ä–µ—Å–≤—ñ–¥—á–∏—Ç–∏—Å—å —â–æ gateway ‚Üí STT ‚Üí Router –ø–æ–≤–µ—Ä—Ç–∞—î —Ç–µ–∫—Å—Ç —ñ TTS-–≤—ñ–¥–ø–æ–≤—ñ–¥—å (–¥–∏–≤–∏—Ç–∏—Å—å –ª–æ–≥–∏ `telegram-gateway` —Ç–∞ `dagi-stt-service`).
2. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ñ–æ—Ç–æ ‚Äî –æ—á—ñ–∫—É–≤–∞—Ç–∏ –æ—Å–º–∏—Å–ª–µ–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ `specialist_vision_8b`.
3. –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–µ–Ω vision fallback, –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ Swapper/vision-encoder —Å–µ—Ä–≤—ñ—Å–∏.

> –Ø–∫—â–æ —á–∞—Ç —Å—Ç–∞—Ä—Ç—É—î –∑ –Ω—É–ª—è, –¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏ —Ü–µ–π –±–ª–æ–∫ —É –ø—Ä–æ–º—Ç –∞–≥–µ–Ω—Ç–∞, —â–æ–± –≤—ñ–Ω –º–∏—Ç—Ç—î–≤–æ –∑—Ä–æ–∑—É–º—ñ–≤ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω —Å–∏—Å—Ç–µ–º–∏.




