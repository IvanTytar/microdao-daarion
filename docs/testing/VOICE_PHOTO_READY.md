# ‚úÖ Voice & Photo Handlers - –ì–û–¢–û–í–û

**–î–∞—Ç–∞**: 2025-11-18  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü—Ä–∞—Ü—é—î

---

## üéâ –©–æ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–æ–≤–∞–Ω–æ:

### 1. **–ì–æ–ª–æ—Å–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è** üé§
- ‚úÖ Voice messages (`.ogg`, `.mp3`)
- ‚úÖ Audio files
- ‚úÖ Video notes (–∫—Ä—É–∂–µ—á–∫–∏)
- ‚úÖ STT —á–µ—Ä–µ–∑ `dagi-stt:9000` (Whisper)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è
- ‚úÖ –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –≤ NATS ‚Üí Router ‚Üí –≤—ñ–¥–ø–æ–≤—ñ–¥—å

### 2. **–§–æ—Ç–æ/–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è** üñºÔ∏è
- ‚úÖ Photo messages
- ‚úÖ Photo –∑ –ø—ñ–¥–ø–∏—Å–æ–º (caption)
- ‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —á–µ—Ä–µ–∑ Telegram API
- ‚úÖ Metadata (`file_url`, `file_id`, `width`, `height`)
- ‚úÖ –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è –≤ NATS –∑ metadata

### 3. **PDF –î–æ–∫—É–º–µ–Ω—Ç–∏** üìÑ
- ‚úÖ PDF file detection
- ‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —á–µ—Ä–µ–∑ Telegram API
- ‚úÖ Metadata (`file_url`, `file_name`, `file_size`)
- ‚úÖ –ì–æ—Ç–æ–≤–æ –¥–æ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –∑ Parser Service

---

## üß™ –Ø–∫ –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏:

### Test 1: –ì–æ–ª–æ—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è üé§

**–ö—Ä–æ–∫ 1**: –í—ñ–¥–∫—Ä–∏—Ç–∏ Telegram  
**–ö—Ä–æ–∫ 2**: –ó–Ω–∞–π—Ç–∏ –±–æ—Ç–∞:
- `@DAARWIZZBot`
- `@energyunionBot` (Helion)
- `@greenfoodliveBot` (GREENFOOD)

**–ö—Ä–æ–∫ 3**: –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω —ñ —Å–∫–∞–∑–∞—Ç–∏: "–ü—Ä–∏–≤—ñ—Ç, —Ä–æ–∑–∫–∞–∂–∏ –ø—Ä–æ MicroDAO"  
**–ö—Ä–æ–∫ 4**: –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
```
–¢–∏ ‚Üí üé§ [–ì–æ–ª–æ—Å–æ–≤–µ 3 —Å–µ–∫]
–ë–æ—Ç ‚Üí üé§ –û–±—Ä–æ–±–ª—è—é –≥–æ–ª–æ—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...
–ë–æ—Ç ‚Üí [–†–æ–∑–ø—ñ–∑–Ω–∞–Ω–∏–π —Ç–µ–∫—Å—Ç + –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∞–≥–µ–Ω—Ç–∞]
```

---

### Test 2: –§–æ—Ç–æ –∑ –ø–∏—Ç–∞–Ω–Ω—è–º üñºÔ∏è

**–ö—Ä–æ–∫ 1**: –í–∏–±—Ä–∞—Ç–∏ –±—É–¥—å-—è–∫–µ —Ñ–æ—Ç–æ  
**–ö—Ä–æ–∫ 2**: –î–æ–¥–∞—Ç–∏ –ø—ñ–¥–ø–∏—Å (caption): "–©–æ –Ω–∞ —Ü—å–æ–º—É –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—ñ?"  
**–ö—Ä–æ–∫ 3**: –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –±–æ—Ç—É

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
```
–¢–∏ ‚Üí üñºÔ∏è [–§–æ—Ç–æ –∑ –ø—ñ–¥–ø–∏—Å–æ–º]
–ë–æ—Ç ‚Üí üñºÔ∏è –û–±—Ä–æ–±–ª—è—é –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è...
–ë–æ—Ç ‚Üí [–í—ñ–¥–ø–æ–≤—ñ–¥—å –ø—Ä–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è]
```

**–ü—Ä–∏–º—ñ—Ç–∫–∞**: –î–ª—è –ø–æ–≤–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —á–µ—Ä–µ–∑ Vision Encoder –ø–æ—Ç—Ä—ñ–±–Ω–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –≤ `router_handler.py`.

---

### Test 3: PDF –¥–æ–∫—É–º–µ–Ω—Ç üìÑ

**–ö—Ä–æ–∫ 1**: –ü—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ PDF —Ñ–∞–π–ª  
**–ö—Ä–æ–∫ 2**: –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –±–æ—Ç—É  
**–ö—Ä–æ–∫ 3**: –î–æ—á–µ–∫–∞—Ç–∏—Å—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
```
–¢–∏ ‚Üí üìÑ document.pdf
–ë–æ—Ç ‚Üí üìÑ –û–±—Ä–æ–±–ª—è—é –¥–æ–∫—É–º–µ–Ω—Ç: document.pdf...
–ë–æ—Ç ‚Üí [–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥—É –∞–±–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è]
```

**–ü—Ä–∏–º—ñ—Ç–∫–∞**: –î–ª—è –ø–æ–≤–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏ PDF –ø–æ—Ç—Ä—ñ–±–Ω–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ Parser Service –≤ `router_handler.py`.

---

## üìä –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ:

### Handlers –≤ `telegram_listener.py`:

#### 1. Text Handler
```python
@dp.message(F.text)
async def on_message(message: Message):
    # –ó–≤–∏—á–∞–π–Ω—ñ —Ç–µ–∫—Å—Ç–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
```

#### 2. Voice Handler
```python
@dp.message(F.voice | F.audio | F.video_note)
async def on_voice(message: Message):
    # –ì–æ–ª–æ—Å–æ–≤—ñ ‚Üí STT ‚Üí —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è ‚Üí NATS
```

#### 3. Document Handler (PDF)
```python
@dp.message(F.document)
async def on_document(message: Message):
    # PDF files ‚Üí metadata ‚Üí NATS
```

#### 4. Photo Handler
```python
@dp.message(F.photo)
async def on_photo(message: Message):
    # –§–æ—Ç–æ ‚Üí metadata ‚Üí NATS
```

---

## üîß –§–∞–π–ª–∏:

### –°—Ç–≤–æ—Ä–µ–Ω—ñ/–û–Ω–æ–≤–ª–µ–Ω—ñ:
1. ‚úÖ `telegram-gateway/app/voice_handler.py` - –æ–±—Ä–æ–±–∫–∞ voice/document
2. ‚úÖ `telegram-gateway/app/telegram_listener.py` - –≤—Å—ñ handlers
3. ‚úÖ `telegram-gateway/app/models.py` - –¥–æ–¥–∞–Ω–æ `metadata` –ø–æ–ª–µ
4. ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –æ—Ñ—ñ—Ü—ñ–π–Ω–æ–≥–æ Telegram API –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤

### URL –¥–ª—è —Ñ–∞–π–ª—ñ–≤:
```python
# Voice, Audio, Document, Photo
file_url = f"https://api.telegram.org/file/bot{bot_token}/{file_path}"
```

---

## üéØ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏ (–æ–ø—Ü—ñ–π–Ω–æ):

### 1. **Vision Encoder Integration** (–¥–ª—è —Ñ–æ—Ç–æ) üî¥
–î–æ–¥–∞—Ç–∏ –≤ `router_handler.py`:
```python
if event.metadata and "photo" in event.metadata:
    photo_info = event.metadata["photo"]
    # Call Vision Encoder Service
    # Analyze image and return description
```

### 2. **Parser Service Integration** (–¥–ª—è PDF) üî¥
–î–æ–¥–∞—Ç–∏ –≤ `router_handler.py`:
```python
if event.metadata and "document" in event.metadata:
    doc_info = event.metadata["document"]
    # Call Parser Service with doc_info["file_url"]
    # Return parsed content
```

### 3. **TTS Integration** (–≥–æ–ª–æ—Å–æ–≤—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ) üü°
- –î–æ–¥–∞—Ç–∏ –æ–ø—Ü—ñ—é –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π
- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –æ–±—Ä–∞—Ç–∏: —Ç–µ–∫—Å—Ç –∞–±–æ –≥–æ–ª–æ—Å

### 4. **Multimodal Chat** (—Ç–µ–∫—Å—Ç + —Ñ–æ—Ç–æ + –≥–æ–ª–æ—Å) üü¢
- –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (—Ç–µ–∫—Å—Ç + –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è)

---

## üìù –õ–æ–≥–∏ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:

### –ì–æ–ª–æ—Å–æ–≤—ñ:
```bash
ssh root@144.76.224.179 "docker logs --tail 100 telegram-gateway | grep 'üé§'"
ssh root@144.76.224.179 "docker logs --tail 50 dagi-stt | grep transcrib"
```

### –§–æ—Ç–æ:
```bash
ssh root@144.76.224.179 "docker logs --tail 100 telegram-gateway | grep 'üñºÔ∏è'"
```

### PDF:
```bash
ssh root@144.76.224.179 "docker logs --tail 100 telegram-gateway | grep 'üìÑ'"
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä—ñ—ó —É—Å–ø—ñ—Ö—É:

### –ì–æ–ª–æ—Å–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:
- [x] –ë–æ—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î "üé§ –û–±—Ä–æ–±–ª—è—é –≥–æ–ª–æ—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..."
- [x] –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è –ø—Ä–∞—Ü—é—î (—É–∫—Ä–∞—ó–Ω—Å—å–∫–∞/–∞–Ω–≥–ª—ñ–π—Å—å–∫–∞)
- [x] –ë–æ—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–æ–≤–∞–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É
- [x] –ù–µ–º–∞—î –ø–æ–º–∏–ª–æ–∫ 404/500 –≤ –ª–æ–≥–∞—Ö

### –§–æ—Ç–æ:
- [x] –ë–æ—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î "üñºÔ∏è –û–±—Ä–æ–±–ª—è—é –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è..."
- [x] Metadata –ø—É–±–ª—ñ–∫—É—î—Ç—å—Å—è –≤ NATS
- [ ] Vision Encoder –∞–Ω–∞–ª—ñ–∑—É—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–ø–æ—Ç—Ä–µ–±—É—î —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó)

### PDF:
- [x] –ë–æ—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î "üìÑ –û–±—Ä–æ–±–ª—è—é –¥–æ–∫—É–º–µ–Ω—Ç: filename.pdf..."
- [x] Metadata –ø—É–±–ª—ñ–∫—É—î—Ç—å—Å—è –≤ NATS
- [ ] Parser Service –æ–±—Ä–æ–±–ª—è—î PDF (–ø–æ—Ç—Ä–µ–±—É—î —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó)

---

## üöÄ –°—Ç–∞—Ç—É—Å:

| –§—É–Ω–∫—Ü—ñ—è | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º—ñ—Ç–∫–∞ |
|---------|--------|----------|
| **Voice ‚Üí STT** | ‚úÖ –ü–†–ê–¶–Æ–Ñ | Whisper base model |
| **Audio ‚Üí STT** | ‚úÖ –ü–†–ê–¶–Æ–Ñ | –í—Å—ñ —Ñ–æ—Ä–º–∞—Ç–∏ |
| **Video Note ‚Üí STT** | ‚úÖ –ü–†–ê–¶–Æ–Ñ | –ö—Ä—É–∂–µ—á–∫–∏ |
| **Photo Detection** | ‚úÖ –ü–†–ê–¶–Æ–Ñ | Metadata –≤ NATS |
| **PDF Detection** | ‚úÖ –ü–†–ê–¶–Æ–Ñ | Metadata –≤ NATS |
| **Vision Analysis** | ‚ö†Ô∏è –ü–æ—Ç—Ä—ñ–±–Ω–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è | Vision Encoder ready |
| **PDF Parsing** | ‚ö†Ô∏è –ü–æ—Ç—Ä—ñ–±–Ω–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è | Parser Service ready |

---

## üéä –ì–æ—Ç–æ–≤–æ –¥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è!

**–°–ø—Ä–æ–±—É–π –∑–∞—Ä–∞–∑**:
1. –í—ñ–¥–ø—Ä–∞–≤ –≥–æ–ª–æ—Å–æ–≤–µ –±—É–¥—å-—è–∫–æ–º—É –±–æ—Ç—É
2. –í—ñ–¥–ø—Ä–∞–≤ —Ñ–æ—Ç–æ –∑ –ø—ñ–¥–ø–∏—Å–æ–º
3. –í—ñ–¥–ø—Ä–∞–≤ PDF –¥–æ–∫—É–º–µ–Ω—Ç

–Ø–∫—â–æ —â–æ—Å—å –Ω–µ –ø—Ä–∞—Ü—é—î - –¥–∏–≤–∏—Å—å –ª–æ–≥–∏ –≤–∏—â–µ —Ç–∞ –ø–∏—à–∏ –º–µ–Ω—ñ! üöÄ

---

*–°—Ç–≤–æ—Ä–µ–Ω–æ: 2025-11-18*  
*–ê–≤—Ç–æ—Ä: Assistant (via Cursor)*  
*–í–µ—Ä—Å—ñ—è: 1.0*

