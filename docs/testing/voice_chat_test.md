# –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —á–∞—Ç—É (STT) —á–µ—Ä–µ–∑ Telegram

**–î–∞—Ç–∞**: 2025-11-18  
**–°–µ—Ä–≤–µ—Ä**: 144.76.224.179  
**–ë–æ—Ç–∏**: DAARWIZZ, Helion, GREENFOOD

---

## üé§ –©–æ —Ç–µ—Å—Ç—É—î–º–æ?

### 1. Speech-to-Text (STT)
- **–°–µ—Ä–≤—ñ—Å**: `dagi-stt` (–ø–æ—Ä—Ç 9000)
- **–ú–æ–¥–µ–ª—å**: Whisper (faster-whisper)
- **–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è**: –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è –≥–æ–ª–æ—Å–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑ Telegram

### 2. –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ Telegram
- **Gateway**: `telegram-gateway` (Long Polling)
- **Endpoint**: `/stt` –Ω–∞ dagi-stt
- **–§–ª–æ—É**: 
  1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞–¥—Å–∏–ª–∞—î –≥–æ–ª–æ—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
  2. Telegram Gateway –æ—Ç—Ä–∏–º—É—î `voice` –∞–±–æ `audio` –∞–±–æ `video_note`
  3. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –∞—É–¥—ñ–æ —á–µ—Ä–µ–∑ Local Telegram Bot API
  4. –í—ñ–¥–ø—Ä–∞–≤–ª—è—î –Ω–∞ `/stt` (dagi-stt)
  5. –û—Ç—Ä–∏–º—É—î —Ç–µ–∫—Å—Ç
  6. –í—ñ–¥–ø—Ä–∞–≤–ª—è—î —Ç–µ–∫—Å—Ç –≤ DAGI Router (—è–∫ –∑–≤–∏—á–∞–π–Ω–µ —Ç–µ–∫—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è)
  7. –ü–æ–≤–µ—Ä—Ç–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É

---

## ‚úÖ –ü–µ—Ä–µ–¥—É–º–æ–≤–∏

### 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ STT —Å–µ—Ä–≤—ñ—Å—É

```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É
docker ps | grep dagi-stt

# –¢–µ—Å—Ç health endpoint (—è–∫—â–æ —î)
curl http://localhost:9000/health

# –õ–æ–≥–∏
docker logs --tail 50 dagi-stt
```

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π –≤–∏–≤—ñ–¥**:
```
INFO:     Started server process [1]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:9000
```

### 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Telegram Gateway

```bash
# –°—Ç–∞—Ç—É—Å
docker ps | grep telegram-gateway

# –õ–æ–≥–∏ (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ polling)
docker logs --tail 50 telegram-gateway | grep -E '(daarwizz|helion|greenfood|polling)'
```

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π –≤–∏–≤—ñ–¥**:
```
INFO:app.telegram_listener:ü§ñ Creating bot: 8323412397:AAFxa...
INFO:aiogram.dispatcher:Run polling for bot @DAARWIZZBot id=8323412397
INFO:aiogram.dispatcher:Run polling for bot @energyunionBot id=8112062582
INFO:aiogram.dispatcher:Run polling for bot @greenfoodliveBot id=7495165343
```

### 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Local Telegram Bot API

```bash
# –°—Ç–∞—Ç—É—Å
docker ps | grep telegram-bot-api

# –¢–µ—Å—Ç
curl http://localhost:8081/bot<TOKEN>/getMe
```

---

## üß™ –ü–ª–∞–Ω —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### Test Case 1: –ë–∞–∑–æ–≤–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è

**–ö—Ä–æ–∫–∏**:
1. –í—ñ–¥–∫—Ä–∏—Ç–∏ Telegram
2. –ó–Ω–∞–π—Ç–∏ –±–æ—Ç–∞ `@DAARWIZZBot` (–∞–±–æ `@energyunionBot`, `@greenfoodliveBot`)
3. –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≥–æ–ª–æ—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é/–∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é)
4. –î–æ—á–µ–∫–∞—Ç–∏—Å—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- –ë–æ—Ç –ø–æ–≤–∏–Ω–µ–Ω –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–æ–º (–ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—ó)
- –ß–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ < 10 —Å–µ–∫—É–Ω–¥

**–õ–æ–≥:**
```
INFO:app.telegram_listener:üì® Received message from chat=<CHAT_ID>
INFO:app.telegram_listener:üì§ Publishing to NATS: agent.telegram.update
INFO:app.router_handler:üì¨ NATS event: agent.telegram.update
INFO:app.router_handler:üîä Voice message detected, calling STT...
INFO:app.router_handler:üìù Transcribed: "–•–æ—á—É –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –ø—Ä–æ MicroDAO"
INFO:app.router_handler:üì§ Sending to Router: mode=chat, message="–•–æ—á—É –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –ø—Ä–æ MicroDAO"
INFO:app.router_handler:‚úÖ Response from Router
INFO:app.telegram_listener:üì§ Sending response to chat=<CHAT_ID>
```

---

### Test Case 2: –î–æ–≤–≥–µ –≥–æ–ª–æ—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è

**–ö—Ä–æ–∫–∏**:
1. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≥–æ–ª–æ—Å–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è > 30 —Å–µ–∫—É–Ω–¥
2. –î–æ—á–µ–∫–∞—Ç–∏—Å—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—ó

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- –£—Å–ø—ñ—à–Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è
- –ß–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ < 20 —Å–µ–∫—É–Ω–¥

---

### Test Case 3: –†—ñ–∑–Ω—ñ –º–æ–≤–∏

**–ö—Ä–æ–∫–∏**:
1. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é: "–ü—Ä–∏–≤—ñ—Ç, —è–∫ —Å–ø—Ä–∞–≤–∏?"
2. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é: "Hello, how are you?"
3. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ä–æ—Å—ñ–π—Å—å–∫–æ—é: "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?"

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- –í—Å—ñ –º–æ–≤–∏ –∫–æ—Ä–µ–∫—Ç–Ω–æ —Ä–æ–∑–ø—ñ–∑–Ω–∞—é—Ç—å—Å—è
- Whisper –ø—ñ–¥—Ç—Ä–∏–º—É—î –º—É–ª—å—Ç–∏–º–æ–≤–Ω—ñ—Å—Ç—å

---

### Test Case 4: –§–æ–Ω–æ–≤—ñ —à—É–º–∏

**–ö—Ä–æ–∫–∏**:
1. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≥–æ–ª–æ—Å–æ–≤–µ –∑ —Ñ–æ–Ω–æ–≤–∏–º —à—É–º–æ–º (–º—É–∑–∏–∫–∞, –≤—É–ª–∏—Ü—è)
2. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —è–∫—ñ—Å—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—ó

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:
- –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è –ø—Ä–∞—Ü—é—î, –∞–ª–µ –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ –ø–æ–º–∏–ª–∫–∏
- –ë–æ—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ë–æ—Ç –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–∞ –≥–æ–ª–æ—Å–æ–≤—ñ

**–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**:
```bash
# 1. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª–æ–≥–∏ telegram-gateway
docker logs --tail 100 telegram-gateway | grep -E '(voice|audio|video_note|STT)'

# 2. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª–æ–≥–∏ dagi-stt
docker logs --tail 100 dagi-stt | grep -E '(POST|/stt|transcrib)'

# 3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å STT
curl http://localhost:9000/health
```

**–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏**:
- STT —Å–µ—Ä–≤—ñ—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω–æ
- Telegram Gateway –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î STT
- –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∞—É–¥—ñ–æ –∑ Telegram
- –ú–æ–¥–µ–ª—ñ Whisper –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ

**–†—ñ—à–µ–Ω–Ω—è**:
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ STT
docker restart dagi-stt

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –º–æ–¥–µ–ª—ñ
docker exec dagi-stt ls -lh /weights/  # –∞–±–æ —ñ–Ω—à–∏–π —à–ª—è—Ö –¥–æ –º–æ–¥–µ–ª–µ–π
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ 2: STT –ø–æ–≤–µ—Ä—Ç–∞—î –ø–æ—Ä–æ–∂–Ω—ñ–π —Ç–µ–∫—Å—Ç

**–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**:
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ñ–æ—Ä–º–∞—Ç –∞—É–¥—ñ–æ
docker logs dagi-stt | grep -i 'format\\|codec\\|error'
```

**–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏**:
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –∞—É–¥—ñ–æ (OGG, MP3, WAV)
- –ó–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–π —Ñ–∞–π–ª (< 1 —Å–µ–∫)
- –ü–æ—à–∫–æ–¥–∂–µ–Ω–∏–π —Ñ–∞–π–ª

**–†—ñ—à–µ–Ω–Ω—è**:
- Telegram –∑–∞–∑–≤–∏—á–∞–π –Ω–∞–¥—Å–∏–ª–∞—î OGG/Opus - Whisper –º–∞—î –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏
- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—é –Ω–∞ —Å—Ç–æ—Ä–æ–Ω—ñ STT —Å–µ—Ä–≤—ñ—Å—É

---

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ü–æ–≤—ñ–ª—å–Ω–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è (> 30 —Å–µ–∫)

**–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**:
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ CPU/RAM
docker stats dagi-stt

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –º–æ–¥–µ–ª—å Whisper
docker exec dagi-stt env | grep WHISPER
```

**–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏**:
- –í–µ–ª–∏–∫–∞ –º–æ–¥–µ–ª—å (large/large-v2) –Ω–∞ CPU
- –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ RAM
- –Ü–Ω—à—ñ –ø—Ä–æ—Ü–µ—Å–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å —Å–µ—Ä–≤–µ—Ä

**–†—ñ—à–µ–Ω–Ω—è**:
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `tiny` –∞–±–æ `base` –º–æ–¥–µ–ª—å –¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ
- –î–æ–¥–∞—Ç–∏ GPU (NVIDIA) –¥–ª—è –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è
- –ó–±—ñ–ª—å—à–∏—Ç–∏ —Ä–µ—Å—É—Ä—Å–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

---

## üìä Metrics –¥–ª—è STT

```promql
# –ö—ñ–ª—å–∫—ñ—Å—Ç—å STT –∑–∞–ø–∏—Ç—ñ–≤
rate(stt_requests_total[5m])

# –ß–∞—Å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—ó (p95)
histogram_quantile(0.95, rate(stt_duration_seconds_bucket[5m]))

# –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–º–∏–ª–æ–∫
rate(stt_errors_total[5m])
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä—ñ—ó —É—Å–ø—ñ—Ö—É

1. ‚úÖ STT —Å–µ—Ä–≤—ñ—Å –ø—Ä–∞—Ü—é—î (`docker ps | grep dagi-stt`)
2. ‚úÖ Telegram Gateway –æ—Ç—Ä–∏–º—É—î –≥–æ–ª–æ—Å–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–ª–æ–≥–∏)
3. ‚úÖ –ë–æ—Ç –∫–æ—Ä–µ–∫—Ç–Ω–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±—É—î —É–∫—Ä–∞—ó–Ω—Å—å–∫—É —Ç–∞ –∞–Ω–≥–ª—ñ–π—Å—å–∫—É
4. ‚úÖ –ß–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ < 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (< 10 —Å–µ–∫ –∞—É–¥—ñ–æ)
5. ‚úÖ –ë–æ—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–æ–≤–∞–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É

---

## üöÄ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

1. –î–æ–¥–∞—Ç–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫—É —ñ–Ω—à–∏—Ö —Ñ–æ—Ä–º–∞—Ç—ñ–≤ (MP3, WAV)
2. –û–ø—Ç–∏–º—ñ–∑—É–≤–∞—Ç–∏ –º–æ–¥–µ–ª—å Whisper (smaller model –∞–±–æ GPU)
3. –î–æ–¥–∞—Ç–∏ –∫–µ—à—É–≤–∞–Ω–Ω—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö —Ñ—Ä–∞–∑
4. –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ TTS –¥–ª—è –ø–æ–≤–Ω–æ—ó voice-to-voice –≤–∑–∞—î–º–æ–¥—ñ—ó

---

*–¢–µ—Å—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ: 2025-11-18*

