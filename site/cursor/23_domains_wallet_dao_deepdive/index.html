
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://IvanTytar.github.io/microdao-daarion/cursor/23_domains_wallet_dao_deepdive/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.18">
    
    
      
        <title>23 — Domains, Wallet Agent & DAO Agent Deep Dive (MicroDAO) - DAARION Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.66ac8b77.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#23-domains-wallet-agent-dao-agent-deep-dive-microdao" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DAARION Documentation" class="md-header__button md-logo" aria-label="DAARION Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DAARION Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              23 — Domains, Wallet Agent & DAO Agent Deep Dive (MicroDAO)
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DAARION Documentation" class="md-nav__button md-logo" aria-label="DAARION Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    DAARION Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../public/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../public/getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../public/architecture-overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../public/daiS_daos_overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DAIS & DAOS
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Internal
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Internal
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Infra
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Infra
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/infra/INFRA_AUTOMATION_PACK_V1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infra Automation Pack v1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/infra/monitoring_overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monitoring Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/infra/nodes_registry_v0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nodes Registry v0
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Specs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Specs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/specs/matrix_presence_aggregator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Matrix Presence Aggregator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/specs/city_map_spec/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    City Map Spec
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/specs/node_join_protocol_draft/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Node Join Protocol (Draft)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="23-domains-wallet-agent-dao-agent-deep-dive-microdao">23 — Domains, Wallet Agent &amp; DAO Agent Deep Dive (MicroDAO)<a class="headerlink" href="#23-domains-wallet-agent-dao-agent-deep-dive-microdao" title="Permanent link">&para;</a></h1>
<p>Технічна специфікація мультидоменного роутингу, Wallet Agent протоколу та DAO Agent синхронізації</p>
<p>Цей документ деталізує три критичних технічних компоненти MicroDAO:</p>
<ol>
<li>
<p><strong>Мульти-тенант домени та роутінг</strong></p>
</li>
<li>
<p><strong>Wallet Agent: безпечний підпис дій</strong></p>
</li>
<li>
<p><strong>DAO Agent: звʼязок із зовнішнім DAO-протоколом</strong></p>
</li>
</ol>
<p>Документ інтегрований із попередніми модулями (12–22).</p>
<hr />
<h1 id="1-multi-tenant-domains-routing">1. MULTI-TENANT DOMAINS &amp; ROUTING<a class="headerlink" href="#1-multi-tenant-domains-routing" title="Permanent link">&para;</a></h1>
<p>MicroDAO має підтримувати:</p>
<ul>
<li>піддомени формату <code>*.daarion.city</code>,</li>
<li>власні домени адміністраторів microDAO,</li>
<li>гнучке маршрутизаційне дерево,</li>
<li>коректну інтеграцію front/back-end,</li>
<li>автоматичні SSL-сертифікати,</li>
<li>безпечне розмежування команд.</li>
</ul>
<hr />
<h2 id="11">1.1. Модель БД<a class="headerlink" href="#11" title="Permanent link">&para;</a></h2>
<h3 id="teams-microdao">Таблиця <code>teams</code> (microDAO)<a class="headerlink" href="#teams-microdao" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="nx">teams</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="o">-</span><span class="w"> </span><span class="nx">slug</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w">            </span><span class="c1">// &quot;greenfood&quot;, &quot;musiclab&quot;</span>
<span class="o">-</span><span class="w"> </span><span class="nx">primary_domain_id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span>
<span class="o">-</span><span class="w"> </span><span class="nx">created_at</span>
</code></pre></div>

<h3 id="domains">Таблиця <code>domains</code><a class="headerlink" href="#domains" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="nx">domains</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="o">-</span><span class="w"> </span><span class="nx">team_id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span>
<span class="o">-</span><span class="w"> </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w">            </span><span class="c1">// &quot;greenfood.daarion.city&quot;, &quot;mydao.org&quot;</span>
<span class="o">-</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pending&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s2">&quot;active&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s2">&quot;disabled&quot;</span>
<span class="o">-</span><span class="w"> </span><span class="nx">is_primary</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span>
<span class="o">-</span><span class="w"> </span><span class="nx">verified_at</span><span class="o">:</span><span class="w"> </span><span class="kt">Date</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span>
<span class="o">-</span><span class="w"> </span><span class="nx">created_at</span>
</code></pre></div>

<hr />
<h2 id="12-currentteamid">1.2. Алгоритм визначення <code>currentTeamId</code> по домену<a class="headerlink" href="#12-currentteamid" title="Permanent link">&para;</a></h2>
<p>На початку кожного HTTP-запиту:</p>
<div class="codehilite"><pre><span></span><code><span class="n">host</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;Host&quot;</span><span class="p">]</span>

<span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">спробувати</span><span class="w"> </span><span class="err">знайти</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="err">у</span><span class="w"> </span><span class="n">domains</span><span class="o">:</span>
<span class="w">   </span><span class="n">SELECT</span><span class="w"> </span><span class="n">team_id</span><span class="w"> </span><span class="n">FROM</span><span class="w"> </span><span class="n">domains</span><span class="w"> </span>
<span class="w">   </span><span class="n">WHERE</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">host</span><span class="w"> </span><span class="n">AND</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&#39;</span><span class="n">active</span><span class="p">&#39;;</span>

<span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="err">якщо</span><span class="w"> </span><span class="err">знайшли</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">currentTeamId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">team_id</span><span class="o">.</span>

<span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="err">якщо</span><span class="w"> </span><span class="err">ні</span><span class="w"> </span><span class="err">—</span><span class="w"> </span><span class="err">це</span><span class="o">,</span><span class="w"> </span><span class="err">можливо</span><span class="o">,</span><span class="w"> </span><span class="err">піддомен</span><span class="w"> </span><span class="n">DAARION</span><span class="o">.</span><span class="n">city</span><span class="o">:</span>
<span class="w">   </span><span class="n">slug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host</span><span class="o">.</span><span class="n">split</span><span class="p">(&#39;</span><span class="o">.</span><span class="p">&#39;)[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">   </span><span class="n">SELECT</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="n">FROM</span><span class="w"> </span><span class="n">teams</span><span class="w"> </span><span class="n">WHERE</span><span class="w"> </span><span class="n">slug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">$</span><span class="n">slug</span><span class="p">;</span>

<span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="err">якщо</span><span class="w"> </span><span class="err">знайшли</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">currentTeamId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="o">.</span>

<span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="err">інакше</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mi">404</span><span class="w"> </span><span class="err">або</span><span class="w"> </span><span class="err">сторінка</span><span class="w"> </span><span class="n">Onboarding</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;microDAO не знайдено&quot;</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="13-ui">1.3. Підтримка двох режимів UI<a class="headerlink" href="#13-ui" title="Permanent link">&para;</a></h2>
<h3 id="1">Режим 1 — Піддомен / власний домен<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p>URL:</p>
<div class="codehilite"><pre><span></span><code>greenfood.daarion.city/
mydao.org/
</code></pre></div>

<p>Усі маршрути стають:</p>
<div class="codehilite"><pre><span></span><code>/ → головна команда
/projects
/agents
/settings
</code></pre></div>

<p><strong>Без /t/:teamId</strong> — тому що <code>teamId</code> вже визначено з домену.</p>
<h3 id="2-appdaarioncity">Режим 2 — Центральний домен (наприклад, app.daarion.city)<a class="headerlink" href="#2-appdaarioncity" title="Permanent link">&para;</a></h3>
<p>URL:</p>
<div class="codehilite"><pre><span></span><code>app.daarion.city/t/:teamId/agents
</code></pre></div>

<p>Цей режим потрібен:</p>
<ul>
<li>для розробки,</li>
<li>для адміністрування,</li>
<li>для роботи всередині DAARION.city як централізованої платформи.</li>
</ul>
<hr />
<h2 id="14-ux">1.4. Налаштування кастомного домену (UX)<a class="headerlink" href="#14-ux" title="Permanent link">&para;</a></h2>
<h3 id="_1">Потік:<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>Адмін відкриває: <strong>Settings → Domain</strong></p>
</li>
<li>
<p>Поле: "Поточний домен: <code>greenfood.daarion.city</code>"</p>
</li>
<li>
<p>Поле: "Додати власний домен" → <code>mydao.org</code></p>
</li>
<li>
<p>Система показує інструкцію:</p>
</li>
</ol>
<p><code>Створіть CNAME:
   mydao.org → domains.daarion.city</code></p>
<ol>
<li>
<p>Домен створюється зі статусом <code>pending</code>.</p>
</li>
<li>
<p>DNS checker (кожні 10 хв) змінює статус на <code>active</code>, коли знайдено CNAME.</p>
</li>
<li>
<p>Автоматичний ACME/SSL випуск.</p>
</li>
<li>
<p>Домен стає primary.</p>
</li>
</ol>
<hr />
<h1 id="2-wallet-agent">2. WALLET AGENT — ПРОТОКОЛ БЕЗПЕЧНОГО ПІДПИСУ<a class="headerlink" href="#2-wallet-agent" title="Permanent link">&para;</a></h1>
<p>Wallet Agent — це <strong>інтерфейс</strong> між microDAO і зовнішніми гаманцями:</p>
<ul>
<li>браузерні (MetaMask, WalletConnect),</li>
<li>мобільні,</li>
<li>апаратні (Tangem-подібні).</li>
</ul>
<p>Wallet Agent <strong>ніколи не отримує приватний ключ</strong>.</p>
<hr />
<h2 id="21">2.1. Потік підпису дії<a class="headerlink" href="#21" title="Permanent link">&para;</a></h2>
<p>Порядок:</p>
<h3 id="1_1">Етап 1 — Агент хоче виконати дію<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<p>Наприклад: Governance Agent хоче оновити правило.</p>
<div class="codehilite"><pre><span></span><code><span class="nx">walletAgent</span><span class="p">.</span><span class="nx">prepare_signature_payload</span><span class="p">({</span>
<span class="w">  </span><span class="nx">action</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;update_policy&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="p">{...}</span>
<span class="p">});</span>
</code></pre></div>

<p>Wallet Agent:</p>
<ol>
<li>Валідатор: "Чи має агент право робити це?"</li>
<li>Створює запис у <code>sign_requests</code>.</li>
<li>Формує <code>human_description</code>.</li>
<li>Показує людині Approval UI.</li>
</ol>
<hr />
<h2 id="22-sign_requests">2.2. Модель <code>sign_requests</code><a class="headerlink" href="#22-sign_requests" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="nx">sign_requests</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="nx">id</span>
<span class="o">-</span><span class="w"> </span><span class="nx">team_id</span>
<span class="o">-</span><span class="w"> </span><span class="kr">type</span><span class="w">                    </span><span class="c1">// &quot;governance_update&quot;, &quot;dao_submit&quot;, ...</span>
<span class="o">-</span><span class="w"> </span><span class="nx">payload_json</span><span class="w">            </span><span class="c1">// те, що треба підписати</span>
<span class="o">-</span><span class="w"> </span><span class="nx">human_description</span>
<span class="o">-</span><span class="w"> </span><span class="nx">created_by_agent_id</span>
<span class="o">-</span><span class="w"> </span><span class="nx">created_by_user_id</span><span class="o">?</span><span class="w">     </span><span class="c1">// якщо ініціатор — людина</span>
<span class="o">-</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pending&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s2">&quot;signed&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s2">&quot;rejected&quot;</span>
<span class="o">-</span><span class="w"> </span><span class="nx">created_at</span>
<span class="o">-</span><span class="w"> </span><span class="nx">updated_at</span>
</code></pre></div>

<hr />
<h2 id="23-ux">2.3. UX у фронтенді<a class="headerlink" href="#23-ux" title="Permanent link">&para;</a></h2>
<p>Коли є новий <code>sign_request</code>:</p>
<ul>
<li>
<p>у UI зʼявляється:</p>
</li>
<li>
<p>"Агент пропонує підписати дію"</p>
</li>
<li>опис,</li>
<li>
<p>кнопки:</p>
<ul>
<li>"Підписати"</li>
<li>"Скасувати"</li>
</ul>
</li>
</ul>
<p>Коли користувач натискає "Підписати":</p>
<ol>
<li>фронт надсилає <code>payload</code> у wallet provider (MetaMask / WC / Tangem SDK),</li>
<li>отримує <code>signature</code>,</li>
<li>викликає:</li>
</ol>
<p><code>POST /sign_requests/:id/confirm
   {
     signature: "0x..."
   }</code></p>
<hr />
<h2 id="24-sign_results">2.4. Таблиця <code>sign_results</code><a class="headerlink" href="#24-sign_results" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="nx">sign_results</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="nx">id</span>
<span class="o">-</span><span class="w"> </span><span class="nx">sign_request_id</span>
<span class="o">-</span><span class="w"> </span><span class="nx">signature</span>
<span class="o">-</span><span class="w"> </span><span class="nx">tx_hash</span><span class="o">?</span><span class="w"> </span>
<span class="o">-</span><span class="w"> </span><span class="nx">confirmed_at</span>
<span class="o">-</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;broadcasted&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s2">&quot;failed&quot;</span>
</code></pre></div>

<hr />
<h2 id="25-wallet-agent-tools">2.5. Wallet Agent Tools<a class="headerlink" href="#25-wallet-agent-tools" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="nx">tools</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="s2">&quot;prepare_signature_payload&quot;</span><span class="p">,</span><span class="w">   </span><span class="c1">// формує sign_request</span>
<span class="w">  </span><span class="s2">&quot;request_signature&quot;</span><span class="p">,</span><span class="w">           </span><span class="c1">// запит до користувача (UI)</span>
<span class="w">  </span><span class="s2">&quot;verify_signature&quot;</span><span class="p">,</span><span class="w">            </span><span class="c1">// перевірка</span>
<span class="w">  </span><span class="s2">&quot;get_wallet_state&quot;</span><span class="w">             </span><span class="c1">// поточні адреси, мережі, доступи</span>
<span class="p">]</span>
</code></pre></div>

<p>Wallet Agent — це декларативна прослойка між дією і підписом користувача.</p>
<hr />
<h1 id="3-dao-agent-on-chain-dao">3. DAO AGENT — СИНХРОНІЗАЦІЯ З ON-CHAIN DAO<a class="headerlink" href="#3-dao-agent-on-chain-dao" title="Permanent link">&para;</a></h1>
<p>Не кожному microDAO потрібен on-chain DAO.</p>
<p>Але архітектура має підтримувати:</p>
<ul>
<li>звʼязок з DAO-контрактами,</li>
<li>синхронізацію ритуалів узгодження microDAO з DAO-голосуваннями,</li>
<li>оновлення локальних правил після голосування,</li>
<li>відправку результатів у DAO-контракт.</li>
</ul>
<hr />
<h2 id="31-dao-agent">3.1. Модель задач DAO Agent<a class="headerlink" href="#31-dao-agent" title="Permanent link">&para;</a></h2>
<h3 id="1-fetch-external-proposals">1) Fetch external proposals<a class="headerlink" href="#1-fetch-external-proposals" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>fetch_dao_proposals(team_id)
</code></pre></div>

<p>Тягне список пропозицій з DAO-контракту чи API.</p>
<h3 id="2-map-rituals-to-proposals">2) Map rituals to proposals<a class="headerlink" href="#2-map-rituals-to-proposals" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>map_ritual_to_proposal(ritual_id, proposal_id)
</code></pre></div>

<p>Звʼязує локальний ритуал і зовнішню пропозицію.</p>
<h3 id="3-submit-local-result-to-dao">3) Submit local result to DAO<a class="headerlink" href="#3-submit-local-result-to-dao" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>submit_ritual_result(ritual_id)
</code></pre></div>

<p>Використовує Wallet Agent для підпису.</p>
<h3 id="4-sync-policy">4) Sync policy<a class="headerlink" href="#4-sync-policy" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>sync_policies_onchain()
</code></pre></div>

<p>Порівнює локальні правила з DAO-версією.</p>
<hr />
<h2 id="32">3.2. Модель БД<a class="headerlink" href="#32" title="Permanent link">&para;</a></h2>
<h3 id="dao_proposals">Таблиця <code>dao_proposals</code><a class="headerlink" href="#dao_proposals" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code><span class="nx">dao_proposals</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="nx">id</span>
<span class="o">-</span><span class="w"> </span><span class="nx">team_id</span>
<span class="o">-</span><span class="w"> </span><span class="nx">proposal_id_onchain</span>
<span class="o">-</span><span class="w"> </span><span class="nx">title</span>
<span class="o">-</span><span class="w"> </span><span class="nx">body</span>
<span class="o">-</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;open&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s2">&quot;closed&quot;</span>
<span class="o">-</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;accepted&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s2">&quot;rejected&quot;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s2">&quot;pending&quot;</span>
<span class="o">-</span><span class="w"> </span><span class="nx">mapped_ritual_id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span>
<span class="o">-</span><span class="w"> </span><span class="nx">created_at</span>
</code></pre></div>

<h3 id="dao_sync_logs">Таблиця <code>dao_sync_logs</code><a class="headerlink" href="#dao_sync_logs" title="Permanent link">&para;</a></h3>
<p>Журнал синхронізації.</p>
<div class="codehilite"><pre><span></span><code><span class="nx">dao_sync_logs</span><span class="o">:</span>
<span class="o">-</span><span class="w"> </span><span class="nx">id</span>
<span class="o">-</span><span class="w"> </span><span class="nx">team_id</span>
<span class="o">-</span><span class="w"> </span><span class="nx">action_type</span>
<span class="o">-</span><span class="w"> </span><span class="nx">payload_json</span>
<span class="o">-</span><span class="w"> </span><span class="nx">created_at</span>
</code></pre></div>

<hr />
<h2 id="33-dao-agent-tools">3.3. DAO Agent Tools<a class="headerlink" href="#33-dao-agent-tools" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="nx">tools</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="s2">&quot;fetch_dao_proposals&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;sync_policies_onchain&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;submit_ritual_result&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;resolve_dao_result&quot;</span>
<span class="p">]</span>
</code></pre></div>

<hr />
<h1 id="4-governance-agent-operatormode">4. Інтеграція з Governance Agent та OperatorMode<a class="headerlink" href="#4-governance-agent-operatormode" title="Permanent link">&para;</a></h1>
<p>DAO Agent працює лише тоді, коли:</p>
<ul>
<li>Governance Agent дозволяє це (entitlement),</li>
<li>Wallet Agent підписує дії людиною.</li>
</ul>
<p>OperatorMode у DAO Agent:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">operatorMode</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">enabled</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">  </span><span class="nx">scopes</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;team&quot;</span><span class="p">],</span>
<span class="w">  </span><span class="nx">allowedTools</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;fetch_dao_proposals&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;sync_policies_onchain&quot;</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nx">schedule</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;0 */6 * * *&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// кожні 6 годин</span>
<span class="w">  </span><span class="nx">maxActionsPerHour</span><span class="o">:</span><span class="w"> </span><span class="kt">5</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Оновлення правил або відправка результатів ритуалу завжди вимагає людського підпису.</strong></p>
<hr />
<h1 id="5-api">5. API ЕНДПОЇНТИ<a class="headerlink" href="#5-api" title="Permanent link">&para;</a></h1>
<h2 id="51-domains-api">5.1. Domains API<a class="headerlink" href="#51-domains-api" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>GET /domains?team_id
POST /domains
PATCH /domains/:id
DELETE /domains/:id
</code></pre></div>

<h2 id="52-wallet-api">5.2. Wallet API<a class="headerlink" href="#52-wallet-api" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>GET /sign_requests?team_id
POST /sign_requests
POST /sign_requests/:id/confirm
POST /sign_requests/:id/reject
</code></pre></div>

<h2 id="53-dao-api">5.3. DAO API<a class="headerlink" href="#53-dao-api" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>GET /dao/proposals?team_id
POST /dao/sync
POST /dao/ritual/:id/submit
</code></pre></div>

<hr />
<h1 id="6-cursor">6. Інструкції для Cursor<a class="headerlink" href="#6-cursor" title="Permanent link">&para;</a></h1>
<div class="codehilite"><pre><span></span><code><span class="n">Use</span><span class="w"> </span><span class="mi">23</span><span class="n">_domains_wallet_dao_deepdive</span><span class="o">.</span><span class="n">md</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">implement</span><span class="p">:</span>

<span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">Multi</span><span class="o">-</span><span class="n">tenant</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="n">routing</span><span class="w"> </span><span class="p">(</span><span class="n">backend</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">frontend</span><span class="p">)</span>

<span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">Domains</span><span class="w"> </span><span class="n">management</span><span class="w"> </span><span class="n">UI</span><span class="w"> </span><span class="p">(</span><span class="n">admin</span><span class="w"> </span><span class="n">area</span><span class="p">)</span>

<span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">Wallet</span><span class="w"> </span><span class="n">Agent</span><span class="w"> </span><span class="n">protocol</span><span class="p">:</span>

<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">sign_requests</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">sign_results</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">prepare_signature_payload</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">confirm</span><span class="o">/</span><span class="n">reject</span><span class="w"> </span><span class="n">endpoints</span>

<span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="n">DAO</span><span class="w"> </span><span class="n">Agent</span><span class="w"> </span><span class="n">backend</span><span class="w"> </span><span class="n">model</span><span class="p">:</span>

<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">dao_proposals</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">dao_sync_logs</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="n">rituals</span><span class="w"> </span><span class="o">&lt;-&gt;</span><span class="w"> </span><span class="n">proposals</span>

<span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="n">Guard</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">DAO</span><span class="w"> </span><span class="n">Agent</span><span class="w"> </span><span class="n">actions</span><span class="w"> </span><span class="n">with</span><span class="p">:</span>

<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Governance</span><span class="o">/</span><span class="n">Access</span><span class="w"> </span><span class="n">entitlements</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Wallet</span><span class="w"> </span><span class="n">signature</span><span class="w"> </span><span class="n">flow</span>

<span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="n">Add</span><span class="w"> </span><span class="n">operatorMode</span><span class="w"> </span><span class="n">guards</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">appropriate</span>
</code></pre></div>

<hr />
<h1 id="7">7. Результат<a class="headerlink" href="#7" title="Permanent link">&para;</a></h1>
<p>Після впровадження:</p>
<ul>
<li>кожне microDAO може мати власний домен без конфігураційної плутанини,</li>
<li>Wallet Agent забезпечує безпечний і прозорий протокол підпису,</li>
<li>DAO Agent може синхронізуватися з зовнішніми DAO-протоколами,</li>
<li>архітектура стає розширюваною для міжпросторових і міжмережевих інтеграцій,</li>
<li>operatorMode забезпечує контрольований автоматизм без ризиків.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.instant", "content.code.copy"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.3220b9d7.min.js"></script>
      
    
  </body>
</html>