
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://IvanTytar.github.io/microdao-daarion/cursor/44_usage_accounting_and_quota_engine/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.18">
    
    
      
        <title>44 — Usage Accounting & Quota Engine (MicroDAO) - DAARION Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.66ac8b77.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#44-usage-accounting-quota-engine-microdao" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DAARION Documentation" class="md-header__button md-logo" aria-label="DAARION Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DAARION Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              44 — Usage Accounting & Quota Engine (MicroDAO)
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DAARION Documentation" class="md-nav__button md-logo" aria-label="DAARION Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    DAARION Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../public/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../public/getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../public/architecture-overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../public/daiS_daos_overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DAIS & DAOS
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Internal
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Internal
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Infra
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Infra
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/infra/INFRA_AUTOMATION_PACK_V1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infra Automation Pack v1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/infra/monitoring_overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monitoring Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/infra/nodes_registry_v0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nodes Registry v0
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Specs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Specs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/specs/matrix_presence_aggregator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Matrix Presence Aggregator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/specs/city_map_spec/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    City Map Spec
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/specs/node_join_protocol_draft/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Node Join Protocol (Draft)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-purpose-scope" class="md-nav__link">
    <span class="md-ellipsis">
      1. Purpose &amp; Scope
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-usage-engine-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      2. Usage Engine Architecture
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-usage-metrics-canonical-list" class="md-nav__link">
    <span class="md-ellipsis">
      3. Usage Metrics (Canonical List)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Usage Metrics (Canonical List)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-compute-llm" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 Compute / LLM:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-agents" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 Agents:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-router" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 Router:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-embassy" class="md-nav__link">
    <span class="md-ellipsis">
      3.4 Embassy:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-rwa" class="md-nav__link">
    <span class="md-ellipsis">
      3.5 RWA:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36-wallet" class="md-nav__link">
    <span class="md-ellipsis">
      3.6 Wallet:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#37-file-storage" class="md-nav__link">
    <span class="md-ellipsis">
      3.7 File Storage:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-quota-types" class="md-nav__link">
    <span class="md-ellipsis">
      4. Quota Types
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Quota Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-hard-quotas" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Hard quotas
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-soft-quotas" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Soft quotas
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-compute-cost-ceilings" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 Compute cost ceilings
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-quota-formula" class="md-nav__link">
    <span class="md-ellipsis">
      5. Quota Formula
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Quota Formula">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-base-quota" class="md-nav__link">
    <span class="md-ellipsis">
      5.1 Base quota
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-multiplier" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 Multiplier
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-counters-storage-model" class="md-nav__link">
    <span class="md-ellipsis">
      6. Counters (Storage Model)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Counters (Storage Model)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-redis-fast-counters" class="md-nav__link">
    <span class="md-ellipsis">
      6.1 Redis (fast counters)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-postgres-durable-counters" class="md-nav__link">
    <span class="md-ellipsis">
      6.2 Postgres (durable counters)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-quota-engine-decision-logic" class="md-nav__link">
    <span class="md-ellipsis">
      7. Quota Engine (Decision Logic)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-warning-thresholds" class="md-nav__link">
    <span class="md-ellipsis">
      8. Warning Thresholds
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-rate-limiting-integration" class="md-nav__link">
    <span class="md-ellipsis">
      9. Rate Limiting Integration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-pdp-integration" class="md-nav__link">
    <span class="md-ellipsis">
      10. PDP Integration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-cost-accounting-1t-integration" class="md-nav__link">
    <span class="md-ellipsis">
      11. Cost Accounting (1T Integration)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-embassy-rwa-quotas" class="md-nav__link">
    <span class="md-ellipsis">
      12. Embassy / RWA Quotas
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-agent-run-limits" class="md-nav__link">
    <span class="md-ellipsis">
      13. Agent Run Limits
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-storagefiles-quotas" class="md-nav__link">
    <span class="md-ellipsis">
      14. Storage/Files Quotas
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-walletchain-quotas" class="md-nav__link">
    <span class="md-ellipsis">
      15. Wallet/Chain Quotas
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-usage-correction-reconciliation" class="md-nav__link">
    <span class="md-ellipsis">
      16. Usage Correction / Reconciliation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#17-governance-controls" class="md-nav__link">
    <span class="md-ellipsis">
      17. Governance Controls
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#18-abuse-fraud-protection" class="md-nav__link">
    <span class="md-ellipsis">
      18. Abuse / Fraud Protection
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#19-observability" class="md-nav__link">
    <span class="md-ellipsis">
      19. Observability
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#20-error-model" class="md-nav__link">
    <span class="md-ellipsis">
      20. Error Model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#21-example-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      21. Example Scenarios
    </span>
  </a>
  
    <nav class="md-nav" aria-label="21. Example Scenarios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#211-llm-overflow" class="md-nav__link">
    <span class="md-ellipsis">
      21.1 LLM Overflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#212-embassy-spam" class="md-nav__link">
    <span class="md-ellipsis">
      21.2 Embassy Spam
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#213-infinite-agent-loop" class="md-nav__link">
    <span class="md-ellipsis">
      21.3 Infinite Agent Loop
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#22-integration-with-other-docs" class="md-nav__link">
    <span class="md-ellipsis">
      22. Integration with Other Docs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#23-cursor" class="md-nav__link">
    <span class="md-ellipsis">
      23. Завдання для Cursor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#24-summary" class="md-nav__link">
    <span class="md-ellipsis">
      24. Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="44-usage-accounting-quota-engine-microdao">44 — Usage Accounting &amp; Quota Engine (MicroDAO)<a class="headerlink" href="#44-usage-accounting-quota-engine-microdao" title="Permanent link">&para;</a></h1>
<p><em>Usage Engine: лічильники, квоти, облік вартості, PDP інтеграція, rate limits, soft/hard limits, попередження, економічна стабільність DAARION OS.</em></p>
<hr />
<h2 id="1-purpose-scope">1. Purpose &amp; Scope<a class="headerlink" href="#1-purpose-scope" title="Permanent link">&para;</a></h2>
<p>Usage Engine — це <strong>центральна система</strong>, яка:</p>
<ul>
<li>обліковує використання ресурсів,</li>
<li>застосовує квоти відповідно до планів (Freemium → Platformium),</li>
<li>коригує ліміти через стейк RINGK,</li>
<li>блокує надмірне використання,</li>
<li>сигналізує API Gateway про warnings/hard-stops,</li>
<li>інтегрується з PDP та Governance.</li>
</ul>
<p>Вона контролює витрати:</p>
<ul>
<li>LLM-токени</li>
<li>agent runs</li>
<li>router invokes</li>
<li>embassy events</li>
<li>storage</li>
<li>wallet tx</li>
<li>compute (1T)</li>
</ul>
<hr />
<h2 id="2-usage-engine-architecture">2. Usage Engine Architecture<a class="headerlink" href="#2-usage-engine-architecture" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>API Gateway / Agents / Embassy / Tools
       ↓
 Usage Accounting Proxy
       ↓
Quota Engine (core)
       ↓
Postgres / Redis (counters)
       ↓
PDP (authorization)
</code></pre></div>

<hr />
<h2 id="3-usage-metrics-canonical-list">3. Usage Metrics (Canonical List)<a class="headerlink" href="#3-usage-metrics-canonical-list" title="Permanent link">&para;</a></h2>
<h3 id="31-compute-llm">3.1 Compute / LLM:<a class="headerlink" href="#31-compute-llm" title="Permanent link">&para;</a></h3>
<ul>
<li><code>llm_tokens_input</code></li>
<li><code>llm_tokens_output</code></li>
<li><code>llm_cost_1t</code></li>
</ul>
<h3 id="32-agents">3.2 Agents:<a class="headerlink" href="#32-agents" title="Permanent link">&para;</a></h3>
<ul>
<li><code>agent_runs</code></li>
<li><code>agent_parallel_runs</code></li>
<li><code>agent_tools_used</code></li>
</ul>
<h3 id="33-router">3.3 Router:<a class="headerlink" href="#33-router" title="Permanent link">&para;</a></h3>
<ul>
<li><code>router.invoke</code></li>
<li><code>router.steps</code></li>
</ul>
<h3 id="34-embassy">3.4 Embassy:<a class="headerlink" href="#34-embassy" title="Permanent link">&para;</a></h3>
<ul>
<li><code>embassy.events_received</code></li>
<li><code>embassy.energy.update</code></li>
<li><code>embassy.food.update</code></li>
<li><code>embassy.water.update</code></li>
</ul>
<h3 id="35-rwa">3.5 RWA:<a class="headerlink" href="#35-rwa" title="Permanent link">&para;</a></h3>
<ul>
<li><code>rwa_processed_records</code></li>
</ul>
<h3 id="36-wallet">3.6 Wallet:<a class="headerlink" href="#36-wallet" title="Permanent link">&para;</a></h3>
<ul>
<li><code>wallet.tx</code></li>
<li><code>payout.claims</code></li>
</ul>
<h3 id="37-file-storage">3.7 File Storage:<a class="headerlink" href="#37-file-storage" title="Permanent link">&para;</a></h3>
<ul>
<li><code>storage.bytes_uploaded</code></li>
<li><code>storage.bytes_retained</code></li>
</ul>
<hr />
<h2 id="4-quota-types">4. Quota Types<a class="headerlink" href="#4-quota-types" title="Permanent link">&para;</a></h2>
<h3 id="41-hard-quotas">4.1 Hard quotas<a class="headerlink" href="#41-hard-quotas" title="Permanent link">&para;</a></h3>
<p>Перевищення → STOP + 403 error.</p>
<p>Приклади:</p>
<ul>
<li>LLM tokens per month</li>
<li>agent runs per day</li>
<li>embassy events per day</li>
<li>browser-lite usage per hour</li>
<li>wallet tx per 10 min</li>
</ul>
<h3 id="42-soft-quotas">4.2 Soft quotas<a class="headerlink" href="#42-soft-quotas" title="Permanent link">&para;</a></h3>
<p>Перевищення → тротлінг, warning headers.</p>
<p>Приклади:</p>
<ul>
<li>router.invoke per minute</li>
<li>search queries</li>
</ul>
<h3 id="43-compute-cost-ceilings">4.3 Compute cost ceilings<a class="headerlink" href="#43-compute-cost-ceilings" title="Permanent link">&para;</a></h3>
<p>Обмеження:</p>
<ul>
<li>per run (<code>max_cost_per_run</code>)</li>
<li>per day</li>
<li>per month</li>
</ul>
<hr />
<h2 id="5-quota-formula">5. Quota Formula<a class="headerlink" href="#5-quota-formula" title="Permanent link">&para;</a></h2>
<p>Кожна квота =</p>
<div class="codehilite"><pre><span></span><code>effective_quota = base_quota(plan) × multiplier(stake)
</code></pre></div>

<p>Де:</p>
<h3 id="51-base-quota">5.1 Base quota<a class="headerlink" href="#51-base-quota" title="Permanent link">&para;</a></h3>
<p>Визначається планом:</p>
<ul>
<li>Freemium → найнижча</li>
<li>Casual</li>
<li>Premium</li>
<li>Platformium → максимальні</li>
</ul>
<h3 id="52-multiplier">5.2 Multiplier<a class="headerlink" href="#52-multiplier" title="Permanent link">&para;</a></h3>
<p>Функція:</p>
<div class="codehilite"><pre><span></span><code>multiplier = f(RINGK_staked)
</code></pre></div>

<p>Приклад:</p>
<table>
<thead>
<tr>
<th>RINGK Stake</th>
<th>Multiplier</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>1.0</td>
</tr>
<tr>
<td>1000</td>
<td>1.25</td>
</tr>
<tr>
<td>5000</td>
<td>1.5</td>
</tr>
<tr>
<td>20000</td>
<td>2.0</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6-counters-storage-model">6. Counters (Storage Model)<a class="headerlink" href="#6-counters-storage-model" title="Permanent link">&para;</a></h2>
<h3 id="61-redis-fast-counters">6.1 Redis (fast counters)<a class="headerlink" href="#61-redis-fast-counters" title="Permanent link">&para;</a></h3>
<p>Проміжні лічильники для:</p>
<ul>
<li>agent_runs</li>
<li>tokens_per_minute</li>
<li>embassy_events</li>
<li>router_invokes</li>
</ul>
<p>Приклад ключів:</p>
<div class="codehilite"><pre><span></span><code>usage:team:{team_id}:llm_month
usage:team:{team_id}:agent_day
usage:user:{user_id}:wallet_tx_hour
</code></pre></div>

<h3 id="62-postgres-durable-counters">6.2 Postgres (durable counters)<a class="headerlink" href="#62-postgres-durable-counters" title="Permanent link">&para;</a></h3>
<ul>
<li>щоденні/місячні агрегати,</li>
<li>історія usage,</li>
<li>перерахунок після crash.</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">usage_daily</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">team_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">metric</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span>
<span class="w">  </span><span class="k">day</span><span class="w"> </span><span class="nb">date</span>
<span class="p">);</span>
</code></pre></div>

<hr />
<h2 id="7-quota-engine-decision-logic">7. Quota Engine (Decision Logic)<a class="headerlink" href="#7-quota-engine-decision-logic" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>allow =
   usage(current) &lt; quota(effective)
</code></pre></div>

<ol>
<li>Виклик надходить від API Gateway.</li>
<li>Usage Engine інкрементує провізорний лічильник.</li>
<li>Перевіряє квоту.</li>
<li>Якщо ок → PDP підтверджує дію.</li>
<li>Якщо переповнення → deny.</li>
</ol>
<hr />
<h2 id="8-warning-thresholds">8. Warning Thresholds<a class="headerlink" href="#8-warning-thresholds" title="Permanent link">&para;</a></h2>
<p>При 80–90% використання:</p>
<div class="codehilite"><pre><span></span><code>X-DAARION-Usage-Warning: &lt;metric&gt; near limit
</code></pre></div>

<p>UI може показувати:</p>
<ul>
<li>«Залишилось 10% LLM бюджету»</li>
<li>«Агентні запуски майже вичерпані»</li>
</ul>
<hr />
<h2 id="9-rate-limiting-integration">9. Rate Limiting Integration<a class="headerlink" href="#9-rate-limiting-integration" title="Permanent link">&para;</a></h2>
<p>Quota Engine тісно працює з rate limits:</p>
<ul>
<li>soft RL: попередження</li>
<li>hard RL: блокування на період</li>
</ul>
<p>Періоди:</p>
<ul>
<li>1 хвилина</li>
<li>10 хвилин</li>
<li>година</li>
<li>доба</li>
<li>місяць</li>
</ul>
<hr />
<h2 id="10-pdp-integration">10. PDP Integration<a class="headerlink" href="#10-pdp-integration" title="Permanent link">&para;</a></h2>
<p>При оцінці дії:</p>
<div class="codehilite"><pre><span></span><code>PDP checks:
  - capability
  - role
  - plan
  - ACL
  - quotas (via Usage Engine)
</code></pre></div>

<p>Usage Engine повертає PDP:</p>
<ul>
<li><code>quota_ok = true/false</code></li>
<li><code>quota_remaining</code></li>
<li><code>cost_estimate</code></li>
</ul>
<hr />
<h2 id="11-cost-accounting-1t-integration">11. Cost Accounting (1T Integration)<a class="headerlink" href="#11-cost-accounting-1t-integration" title="Permanent link">&para;</a></h2>
<ol>
<li>LLM Proxy обчислює:</li>
</ol>
<div class="codehilite"><pre><span></span><code>cost_1t = tokens × price_per_token
</code></pre></div>

<ol>
<li>Router/Agent додає:</li>
</ol>
<div class="codehilite"><pre><span></span><code>cost_1t += tool_cost
</code></pre></div>

<ol>
<li>Usage Engine додає:</li>
</ol>
<div class="codehilite"><pre><span></span><code>team_monthly_compute += cost_1t
</code></pre></div>

<ol>
<li>PDP блокує, якщо:</li>
</ol>
<div class="codehilite"><pre><span></span><code>team_monthly_compute &gt; compute_quota
</code></pre></div>

<hr />
<h2 id="12-embassy-rwa-quotas">12. Embassy / RWA Quotas<a class="headerlink" href="#12-embassy-rwa-quotas" title="Permanent link">&para;</a></h2>
<p>Щоб уникнути спаму і фродових оновлень:</p>
<table>
<thead>
<tr>
<th>Domain</th>
<th>Limit</th>
</tr>
</thead>
<tbody>
<tr>
<td>energy</td>
<td>10 000 updates/day</td>
</tr>
<tr>
<td>food</td>
<td>5 000 updates/day</td>
</tr>
<tr>
<td>water</td>
<td>5 000 updates/day</td>
</tr>
</tbody>
</table>
<p>Також:</p>
<div class="codehilite"><pre><span></span><code>max_events_per_minute (per platform)
</code></pre></div>

<hr />
<h2 id="13-agent-run-limits">13. Agent Run Limits<a class="headerlink" href="#13-agent-run-limits" title="Permanent link">&para;</a></h2>
<p>Окремі ліміти:</p>
<ul>
<li>max_runs_per_day</li>
<li>max_parallel_runs</li>
<li>max_tools_per_run</li>
<li>max_llm_tokens_per_run</li>
<li>max_cost_per_run</li>
</ul>
<hr />
<h2 id="14-storagefiles-quotas">14. Storage/Files Quotas<a class="headerlink" href="#14-storagefiles-quotas" title="Permanent link">&para;</a></h2>
<p>На команду:</p>
<div class="codehilite"><pre><span></span><code>Freemium: 100MB
Casual: 500MB
Premium: 5GB
Platformium: 25GB+
</code></pre></div>

<hr />
<h2 id="15-walletchain-quotas">15. Wallet/Chain Quotas<a class="headerlink" href="#15-walletchain-quotas" title="Permanent link">&para;</a></h2>
<p>З метою безпеки:</p>
<div class="codehilite"><pre><span></span><code>max_wallet_tx_per_hour = 2
max_claims_per_day = 10
max_stake_ops_per_day = 5
</code></pre></div>

<hr />
<h2 id="16-usage-correction-reconciliation">16. Usage Correction / Reconciliation<a class="headerlink" href="#16-usage-correction-reconciliation" title="Permanent link">&para;</a></h2>
<p>Раз на добу:</p>
<ul>
<li>Redis → PostgreSQL sync</li>
<li>anomaly detection</li>
<li>usage recalculation для long tasks (agent runs)</li>
<li>звірка tokens_used з LLM Proxy</li>
</ul>
<hr />
<h2 id="17-governance-controls">17. Governance Controls<a class="headerlink" href="#17-governance-controls" title="Permanent link">&para;</a></h2>
<p>Governance може:</p>
<ul>
<li>підвищувати/знижувати квоти,</li>
<li>змінювати compute price,</li>
<li>вимикати окремі метрики,</li>
<li>вводити "emergency cap",</li>
<li>змінювати stake multipliers.</li>
</ul>
<hr />
<h2 id="18-abuse-fraud-protection">18. Abuse / Fraud Protection<a class="headerlink" href="#18-abuse-fraud-protection" title="Permanent link">&para;</a></h2>
<p>Виявляє:</p>
<ul>
<li>різкі стрибки usage,</li>
<li>автоматичні цикли агентів,</li>
<li>LLM infinite loops,</li>
<li>embassy spam,</li>
<li>wallet brute-force,</li>
<li>chain-попит аномальний.</li>
</ul>
<p>Система автоматично може:</p>
<ul>
<li>знизити квоти тимчасово,</li>
<li>заблокувати агентів,</li>
<li>призупинити Embassy platform,</li>
<li>вимкнути інструменти.</li>
</ul>
<hr />
<h2 id="19-observability">19. Observability<a class="headerlink" href="#19-observability" title="Permanent link">&para;</a></h2>
<p>Метрики:</p>
<ul>
<li>usage per minute/day/month</li>
<li>quota remaining</li>
<li>cost per run</li>
<li>agent tokens used</li>
<li>embassy event rate</li>
<li>router invoke rate</li>
<li>anomaly score</li>
</ul>
<p>Графіки в Grafana:</p>
<ul>
<li>per сервіс</li>
<li>per команду</li>
<li>per користувача</li>
<li>per домен (RWA/Energy/Food/Water)</li>
</ul>
<hr />
<h2 id="20-error-model">20. Error Model<a class="headerlink" href="#20-error-model" title="Permanent link">&para;</a></h2>
<p>Коди помилок Usage Engine:</p>
<table>
<thead>
<tr>
<th>Code</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>quota_exceeded</td>
<td>перевищено квоту</td>
</tr>
<tr>
<td>cost_exceeded</td>
<td>обчислювальний бюджет вичерпано</td>
</tr>
<tr>
<td>rate_limited</td>
<td>надто багато дій</td>
</tr>
<tr>
<td>anomaly_detected</td>
<td>підозрілий патерн</td>
</tr>
<tr>
<td>agent_parallel_limit</td>
<td>забагато агентів</td>
</tr>
<tr>
<td>tokens_limit</td>
<td>LLM usage overflow</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="21-example-scenarios">21. Example Scenarios<a class="headerlink" href="#21-example-scenarios" title="Permanent link">&para;</a></h2>
<h3 id="211-llm-overflow">21.1 LLM Overflow<a class="headerlink" href="#211-llm-overflow" title="Permanent link">&para;</a></h3>
<ul>
<li>Користувач запитує великий контекст → tokens_used &gt; quota → deny.</li>
</ul>
<h3 id="212-embassy-spam">21.2 Embassy Spam<a class="headerlink" href="#212-embassy-spam" title="Permanent link">&para;</a></h3>
<ul>
<li>EnergyUnion шле 10k events/min → throttling → deny.</li>
</ul>
<h3 id="213-infinite-agent-loop">21.3 Infinite Agent Loop<a class="headerlink" href="#213-infinite-agent-loop" title="Permanent link">&para;</a></h3>
<ul>
<li>Агент намагається робити 50 runs/min → deny.</li>
</ul>
<hr />
<h2 id="22-integration-with-other-docs">22. Integration with Other Docs<a class="headerlink" href="#22-integration-with-other-docs" title="Permanent link">&para;</a></h2>
<p>Цей документ доповнює:</p>
<ul>
<li><code>32_policy_service_PDP_design.md</code></li>
<li><code>30_cost_optimization_and_token_economics_infrastructure.md</code></li>
<li><code>31_governance_policies_for_capabilities_and_quotas.md</code></li>
<li><code>40_rwa_energy_food_water_flow_specs.md</code></li>
<li><code>38_private_agents_lifecycle_and_management.md</code></li>
</ul>
<hr />
<h2 id="23-cursor">23. Завдання для Cursor<a class="headerlink" href="#23-cursor" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>You are a senior backend engineer. Implement Usage Accounting &amp; Quota Engine using:
- 44_usage_accounting_and_quota_engine.md
- 32_policy_service_PDP_design.md
- 30_cost_optimization_and_token_economics_infrastructure.md

Tasks:
1) Create Usage Engine service architecture (Usage Accounting Proxy, Quota Engine, Redis/Postgres counters).
2) Define Usage Metrics (LLM tokens, agent runs, router invokes, embassy events, RWA, wallet tx, storage).
3) Implement Quota Types (Hard quotas, Soft quotas, Compute cost ceilings).
4) Implement Quota Formula (base_quota(plan) × multiplier(stake)).
5) Create Counters Storage Model (Redis for fast counters, Postgres for durable counters).
6) Implement Quota Engine Decision Logic (usage check, quota validation, PDP integration).
7) Add Warning Thresholds (80-90% usage warnings).
8) Integrate Rate Limiting (soft/hard limits, time periods).
9) Integrate with PDP (quota_ok, quota_remaining, cost_estimate).
10) Implement Cost Accounting (1T integration, LLM Proxy cost calculation, team monthly compute).
11) Add Embassy/RWA Quotas (per domain limits, max_events_per_minute).
12) Implement Agent Run Limits (max_runs_per_day, max_parallel_runs, max_tools_per_run, max_llm_tokens_per_run, max_cost_per_run).
13) Add Storage/Files Quotas (per plan limits).
14) Implement Wallet/Chain Quotas (max_wallet_tx_per_hour, max_claims_per_day, max_stake_ops_per_day).
15) Add Usage Correction / Reconciliation (Redis → PostgreSQL sync, anomaly detection, usage recalculation).
16) Add Governance Controls (quota updates, compute price changes, emergency cap, stake multipliers).
17) Implement Abuse / Fraud Protection (anomaly detection, automatic quota reduction, agent blocking, embassy suspension).
18) Add Observability (metrics, Grafana dashboards).
19) Implement Error Model (quota_exceeded, cost_exceeded, rate_limited, anomaly_detected, agent_parallel_limit, tokens_limit).

Output:
- list of modified files
- diff
- summary
</code></pre></div>

<hr />
<h2 id="24-summary">24. Summary<a class="headerlink" href="#24-summary" title="Permanent link">&para;</a></h2>
<p>Usage Engine:</p>
<ul>
<li>гарантує економічну стабільність системи,</li>
<li>контролює всі ресурси,</li>
<li>застосовує квоти,</li>
<li>працює з PDP, Agents, Embassy, Wallet, Tools,</li>
<li>захищає систему від зловживань,</li>
<li>базується на Redis + Postgres,</li>
<li>повністю конфігурується Governance,</li>
<li>забезпечує масштабовану, передбачувану, справедливу модель використання DAARION OS.</li>
</ul>
<p>Це — <strong>центральний обліковий шар платформи</strong>.</p>
<hr />
<p><strong>Версія:</strong> 1.0<br />
<strong>Останнє оновлення:</strong> 2024-11-14</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.instant", "content.code.copy"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.3220b9d7.min.js"></script>
      
    
  </body>
</html>