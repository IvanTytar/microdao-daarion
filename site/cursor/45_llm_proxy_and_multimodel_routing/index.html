
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://IvanTytar.github.io/microdao-daarion/cursor/45_llm_proxy_and_multimodel_routing/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.18">
    
    
      
        <title>45 — LLM Proxy & Multi-Model Routing (MicroDAO) - DAARION Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.66ac8b77.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#45-llm-proxy-multi-model-routing-microdao" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="DAARION Documentation" class="md-header__button md-logo" aria-label="DAARION Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            DAARION Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              45 — LLM Proxy & Multi-Model Routing (MicroDAO)
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="DAARION Documentation" class="md-nav__button md-logo" aria-label="DAARION Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    DAARION Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../public/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../public/getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../public/architecture-overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../public/daiS_daos_overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DAIS & DAOS
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Internal
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Internal
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Infra
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Infra
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/infra/INFRA_AUTOMATION_PACK_V1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Infra Automation Pack v1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/infra/monitoring_overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monitoring Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/infra/nodes_registry_v0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Nodes Registry v0
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Specs
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            Specs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/specs/matrix_presence_aggregator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Matrix Presence Aggregator
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/specs/city_map_spec/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    City Map Spec
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../internal/specs/node_join_protocol_draft/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Node Join Protocol (Draft)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-purpose-scope" class="md-nav__link">
    <span class="md-ellipsis">
      1. Purpose &amp; Scope
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-high-level-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      2. High-Level Architecture
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-why-not-call-llm-directly" class="md-nav__link">
    <span class="md-ellipsis">
      3. Why Not Call LLM Directly?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-core-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      4. Core Responsibilities
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-supported-model-types" class="md-nav__link">
    <span class="md-ellipsis">
      5. Supported Model Types
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Supported Model Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-text-models" class="md-nav__link">
    <span class="md-ellipsis">
      5.1 Text models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-vision-models" class="md-nav__link">
    <span class="md-ellipsis">
      5.2 Vision models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-embeddings" class="md-nav__link">
    <span class="md-ellipsis">
      5.3 Embeddings
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54-code-models" class="md-nav__link">
    <span class="md-ellipsis">
      5.4 Code Models
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55-audio" class="md-nav__link">
    <span class="md-ellipsis">
      5.5 Audio
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-normalized-request-schema" class="md-nav__link">
    <span class="md-ellipsis">
      6. Normalized Request Schema
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-routing-modes" class="md-nav__link">
    <span class="md-ellipsis">
      7. Routing Modes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Routing Modes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-mode-a-direct" class="md-nav__link">
    <span class="md-ellipsis">
      7.1 Mode A — DIRECT
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-mode-b-tiered-routing" class="md-nav__link">
    <span class="md-ellipsis">
      7.2 Mode B — TIERED ROUTING
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-mode-c-specialized" class="md-nav__link">
    <span class="md-ellipsis">
      7.3 Mode C — Specialized
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-fallback-logic" class="md-nav__link">
    <span class="md-ellipsis">
      8. Fallback Logic
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-prompt-sanitization-layer" class="md-nav__link">
    <span class="md-ellipsis">
      9. Prompt Sanitization Layer
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-confidential-mode" class="md-nav__link">
    <span class="md-ellipsis">
      10. Confidential Mode
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-pdp-integration" class="md-nav__link">
    <span class="md-ellipsis">
      11. PDP Integration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-token-counting" class="md-nav__link">
    <span class="md-ellipsis">
      12. Token Counting
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-cost-calculation-1t-integration" class="md-nav__link">
    <span class="md-ellipsis">
      13. Cost Calculation (1T Integration)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-multi-model-orchestration" class="md-nav__link">
    <span class="md-ellipsis">
      14. Multi-Model Orchestration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="14. Multi-Model Orchestration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#141-router-style-chains" class="md-nav__link">
    <span class="md-ellipsis">
      14.1 Router-Style Chains
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#142-vision-reasoning-flow" class="md-nav__link">
    <span class="md-ellipsis">
      14.2 Vision → Reasoning flow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#143-agents-tools-llm-memory" class="md-nav__link">
    <span class="md-ellipsis">
      14.3 Agents → Tools → LLM → Memory
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-error-model" class="md-nav__link">
    <span class="md-ellipsis">
      15. Error Model
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-retry-timeouts" class="md-nav__link">
    <span class="md-ellipsis">
      16. Retry / Timeouts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="16. Retry / Timeouts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#timeouts" class="md-nav__link">
    <span class="md-ellipsis">
      Timeouts:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retry" class="md-nav__link">
    <span class="md-ellipsis">
      Retry:
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#17-model-selection-logic-pseudo" class="md-nav__link">
    <span class="md-ellipsis">
      17. Model Selection Logic (Pseudo)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#18-local-model-constraints" class="md-nav__link">
    <span class="md-ellipsis">
      18. Local Model Constraints
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#19-autoscaling" class="md-nav__link">
    <span class="md-ellipsis">
      19. Autoscaling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#20-logging-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      20. Logging &amp; Monitoring
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#21-safety-guardrails" class="md-nav__link">
    <span class="md-ellipsis">
      21. Safety / Guardrails
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#22-example-complete-flow" class="md-nav__link">
    <span class="md-ellipsis">
      22. Example Complete Flow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#23-integration-with-other-docs" class="md-nav__link">
    <span class="md-ellipsis">
      23. Integration with Other Docs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#24-cursor" class="md-nav__link">
    <span class="md-ellipsis">
      24. Завдання для Cursor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#25-summary" class="md-nav__link">
    <span class="md-ellipsis">
      25. Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="45-llm-proxy-multi-model-routing-microdao">45 — LLM Proxy &amp; Multi-Model Routing (MicroDAO)<a class="headerlink" href="#45-llm-proxy-multi-model-routing-microdao" title="Permanent link">&para;</a></h1>
<p><em>LLM Proxy: маршрутизація моделей, cost control, токени, PDP, sandbox, autoscaling, fallback-логіка, multimodel orchestration</em></p>
<hr />
<h2 id="1-purpose-scope">1. Purpose &amp; Scope<a class="headerlink" href="#1-purpose-scope" title="Permanent link">&para;</a></h2>
<p>LLM Proxy — це <strong>єдина точка</strong> взаємодії DAARION.city з усіма LLM:</p>
<ul>
<li>OpenAI</li>
<li>Anthropic</li>
<li>Local models</li>
<li>Vision models</li>
<li>Embeddings</li>
<li>Code models</li>
<li>Audio (ASR/TTS)</li>
</ul>
<p>Він:</p>
<ul>
<li>нормалізує API,</li>
<li>викликає правильну модель,</li>
<li>керує витратами,</li>
<li>обмежує usage,</li>
<li>запускає fallback,</li>
<li>дає PDP-контроль,</li>
<li>маскує системні інструкції,</li>
<li>приховує chain-of-thought.</li>
</ul>
<hr />
<h2 id="2-high-level-architecture">2. High-Level Architecture<a class="headerlink" href="#2-high-level-architecture" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>Agent / Router / Tools
         ↓
      API Gateway (PEP)
         ↓
       LLM Proxy
         ↓
 Multi-Model Router Engine
         ↓
 Providers / Local Models / Vision / Embeddings
</code></pre></div>

<hr />
<h2 id="3-why-not-call-llm-directly">3. Why Not Call LLM Directly?<a class="headerlink" href="#3-why-not-call-llm-directly" title="Permanent link">&para;</a></h2>
<p>LLM Proxy — єдиний спосіб гарантувати:</p>
<ul>
<li>безпеку (PDP checks),</li>
<li>облік usage,</li>
<li>стале ціноутворення,</li>
<li>контроль cost explosion,</li>
<li>фільтрацію危险 prompt-ів,</li>
<li>policy-based routing (cheap → medium → best),</li>
<li>інституційну інтеграцію policy-рівня.</li>
</ul>
<p>Жоден агент, сервіс чи tool <strong>не має прямого доступу</strong> до LLM API.</p>
<hr />
<h2 id="4-core-responsibilities">4. Core Responsibilities<a class="headerlink" href="#4-core-responsibilities" title="Permanent link">&para;</a></h2>
<ul>
<li>маршрутизація між моделями</li>
<li>облік токенів</li>
<li>облік вартості (1T)</li>
<li>ліміти usage</li>
<li>fallback до дешевших моделей</li>
<li>нормалізація інтерфейсів</li>
<li>конфіденційність (при confidential mode)</li>
<li>безпека (prompt sanitizer)</li>
<li>логування</li>
<li>autoscaling воркерів</li>
<li>дотримання governance-політик</li>
</ul>
<hr />
<h2 id="5-supported-model-types">5. Supported Model Types<a class="headerlink" href="#5-supported-model-types" title="Permanent link">&para;</a></h2>
<h3 id="51-text-models">5.1 Text models<a class="headerlink" href="#51-text-models" title="Permanent link">&para;</a></h3>
<ul>
<li>gpt-4.1-mini</li>
<li>gpt-4o</li>
<li>sonnet</li>
<li>local LLaMA xB</li>
<li>Mistral інструктажні</li>
</ul>
<h3 id="52-vision-models">5.2 Vision models<a class="headerlink" href="#52-vision-models" title="Permanent link">&para;</a></h3>
<ul>
<li>gpt-4o-vision</li>
<li>llava-v1.6</li>
<li>open-clip inference</li>
</ul>
<h3 id="53-embeddings">5.3 Embeddings<a class="headerlink" href="#53-embeddings" title="Permanent link">&para;</a></h3>
<ul>
<li>text-embedding-3-small</li>
<li>local embeddings BGE-large</li>
</ul>
<h3 id="54-code-models">5.4 Code Models<a class="headerlink" href="#54-code-models" title="Permanent link">&para;</a></h3>
<ul>
<li>gpt-o1</li>
<li>Claude Code</li>
<li>local starcoder</li>
</ul>
<h3 id="55-audio">5.5 Audio<a class="headerlink" href="#55-audio" title="Permanent link">&para;</a></h3>
<ul>
<li>Whisper</li>
<li>Local ASR/TTS</li>
</ul>
<hr />
<h2 id="6-normalized-request-schema">6. Normalized Request Schema<a class="headerlink" href="#6-normalized-request-schema" title="Permanent link">&para;</a></h2>
<p>Усі LLM запити приходять у форматі:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;model&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;auto|gpt-4o-mini|sonnet&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">...</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;max_tokens&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">4096</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;temperature&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;tools&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">...</span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;context&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;team_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;t_555&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;agent_run_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ar_001&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;confidential&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="7-routing-modes">7. Routing Modes<a class="headerlink" href="#7-routing-modes" title="Permanent link">&para;</a></h2>
<h3 id="71-mode-a-direct">7.1 Mode A — DIRECT<a class="headerlink" href="#71-mode-a-direct" title="Permanent link">&para;</a></h3>
<p>Використати точно зазначену модель.</p>
<h3 id="72-mode-b-tiered-routing">7.2 Mode B — TIERED ROUTING<a class="headerlink" href="#72-mode-b-tiered-routing" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>cheap → balanced → premium
</code></pre></div>

<p>Приклад логіки:</p>
<div class="codehilite"><pre><span></span><code>Якщо контекст короткий → gpt-4o-mini
Якщо потрібний reasoning → gpt-4o
Якщо треба vision → gpt-4o-vision
</code></pre></div>

<h3 id="73-mode-c-specialized">7.3 Mode C — Specialized<a class="headerlink" href="#73-mode-c-specialized" title="Permanent link">&para;</a></h3>
<ul>
<li>код → code model</li>
<li>embeddings → embedding model</li>
<li>vision → vision pipeline</li>
</ul>
<hr />
<h2 id="8-fallback-logic">8. Fallback Logic<a class="headerlink" href="#8-fallback-logic" title="Permanent link">&para;</a></h2>
<ol>
<li>Якщо модель 503/timeout:</li>
</ol>
<p><code>text
   fallback to same-tier alternative</code></p>
<ol>
<li>Якщо токени не поміщаються:</li>
</ol>
<p><code>text
   fallback to compression (summaries)</code></p>
<ol>
<li>Якщо залишився малий бюджет 1T:</li>
</ol>
<p><code>text
   fallback to cheaper model</code></p>
<hr />
<h2 id="9-prompt-sanitization-layer">9. Prompt Sanitization Layer<a class="headerlink" href="#9-prompt-sanitization-layer" title="Permanent link">&para;</a></h2>
<p>Перед викликом моделі LLM Proxy:</p>
<ul>
<li>видаляє інструкції, що намагаються зняти обмеження,</li>
<li>фільтрує injections:</li>
</ul>
<p><code>text
  ignore previous instructions</code></p>
<ul>
<li>видаляє відомі jailbreak patterns,</li>
<li>шифрує або редагує конфіденційні частини,</li>
<li>перетворює спецсимволи.</li>
</ul>
<hr />
<h2 id="10-confidential-mode">10. Confidential Mode<a class="headerlink" href="#10-confidential-mode" title="Permanent link">&para;</a></h2>
<p>Якщо у контексті:</p>
<div class="codehilite"><pre><span></span><code>confidential = true
</code></pre></div>

<p>Тоді LLM Proxy:</p>
<ul>
<li>ховає/редагує plaintext,</li>
<li>подає тільки summary/embeddings,</li>
<li>забороняє інструменти з full text,</li>
<li>вимикає vision (бо містить raw data).</li>
</ul>
<hr />
<h2 id="11-pdp-integration">11. PDP Integration<a class="headerlink" href="#11-pdp-integration" title="Permanent link">&para;</a></h2>
<p>Перед виконанням:</p>
<div class="codehilite"><pre><span></span><code>PDP(authorize tool.llm.invoke)
</code></pre></div>

<p>Після — Usage Engine:</p>
<div class="codehilite"><pre><span></span><code>usage.llm.increment(tokens)
cost_1t = tokens * price
quota.check()
</code></pre></div>

<hr />
<h2 id="12-token-counting">12. Token Counting<a class="headerlink" href="#12-token-counting" title="Permanent link">&para;</a></h2>
<p>Підтримуються:</p>
<ul>
<li>exact token count</li>
<li>pre-count estimation</li>
<li>streaming token accumulation</li>
</ul>
<p>LLM Proxy повертає:</p>
<div class="codehilite"><pre><span></span><code><span class="nt">&quot;usage&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;prompt_tokens&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1321</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;completion_tokens&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">552</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;total_tokens&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1873</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="13-cost-calculation-1t-integration">13. Cost Calculation (1T Integration)<a class="headerlink" href="#13-cost-calculation-1t-integration" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>cost_1t = total_tokens × model_price
</code></pre></div>

<p><em>model_price</em> задається Governance.</p>
<p>Зберігається у:</p>
<ul>
<li>usage counters,</li>
<li>agent run summary,</li>
<li>analytics.</li>
</ul>
<hr />
<h2 id="14-multi-model-orchestration">14. Multi-Model Orchestration<a class="headerlink" href="#14-multi-model-orchestration" title="Permanent link">&para;</a></h2>
<p>Підтримує:</p>
<h3 id="141-router-style-chains">14.1 Router-Style Chains<a class="headerlink" href="#141-router-style-chains" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>step 1 → llm-mini
step 2 → llm-large
step 3 → embeddings
step 4 → llm-mini
</code></pre></div>

<h3 id="142-vision-reasoning-flow">14.2 Vision → Reasoning flow<a class="headerlink" href="#142-vision-reasoning-flow" title="Permanent link">&para;</a></h3>
<div class="codehilite"><pre><span></span><code>image → vision encoder → LLM → tools → report
</code></pre></div>

<h3 id="143-agents-tools-llm-memory">14.3 Agents → Tools → LLM → Memory<a class="headerlink" href="#143-agents-tools-llm-memory" title="Permanent link">&para;</a></h3>
<hr />
<h2 id="15-error-model">15. Error Model<a class="headerlink" href="#15-error-model" title="Permanent link">&para;</a></h2>
<p>LLM Proxy повертає:</p>
<table>
<thead>
<tr>
<th>Code</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>llm_timeout</td>
<td>провайдер не відповів</td>
</tr>
<tr>
<td>llm_over_quota</td>
<td>usage &gt; quota</td>
</tr>
<tr>
<td>llm_confidential_violation</td>
<td>текст неможливо подати в модель</td>
</tr>
<tr>
<td>llm_model_unavailable</td>
<td>модель недоступна</td>
</tr>
<tr>
<td>llm_input_too_large</td>
<td>не поміщається у контекст</td>
</tr>
<tr>
<td>llm_safety_block</td>
<td>jailbreak / unsafe</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="16-retry-timeouts">16. Retry / Timeouts<a class="headerlink" href="#16-retry-timeouts" title="Permanent link">&para;</a></h2>
<h3 id="timeouts">Timeouts:<a class="headerlink" href="#timeouts" title="Permanent link">&para;</a></h3>
<ul>
<li>mini models: 10–25s</li>
<li>main models: 25–60s</li>
<li>vision: 45–90s</li>
</ul>
<h3 id="retry">Retry:<a class="headerlink" href="#retry" title="Permanent link">&para;</a></h3>
<ul>
<li>кожну помилку класифікує Router Engine,</li>
<li>retry через 1–5 секунд,</li>
<li>не більше 2 разів.</li>
</ul>
<hr />
<h2 id="17-model-selection-logic-pseudo">17. Model Selection Logic (Pseudo)<a class="headerlink" href="#17-model-selection-logic-pseudo" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">has_images</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;gpt-4o-vision&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">tokens</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;gpt-4o-mini&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">requires_reasoning</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;gpt-4o&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;sonnet&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">model</span>
</code></pre></div>

<hr />
<h2 id="18-local-model-constraints">18. Local Model Constraints<a class="headerlink" href="#18-local-model-constraints" title="Permanent link">&para;</a></h2>
<p>Local LLaMA/mistral використовуються коли:</p>
<ul>
<li>confidential mode активний,</li>
<li>cost override,</li>
<li>автономна інфраструктура (offline mode).</li>
</ul>
<p>Обмеження:</p>
<ul>
<li>контекст менше,</li>
<li>reasoning слабший,</li>
<li>відповіді короткі,</li>
<li>інструменти зведені до мінімуму.</li>
</ul>
<hr />
<h2 id="19-autoscaling">19. Autoscaling<a class="headerlink" href="#19-autoscaling" title="Permanent link">&para;</a></h2>
<p>LLM Proxy має worker pools:</p>
<ul>
<li>text workers</li>
<li>vision workers</li>
<li>embeddings workers</li>
</ul>
<p>Autoscaling тригериться:</p>
<ul>
<li>queue size</li>
<li>average latency</li>
<li>error rate</li>
</ul>
<hr />
<h2 id="20-logging-monitoring">20. Logging &amp; Monitoring<a class="headerlink" href="#20-logging-monitoring" title="Permanent link">&para;</a></h2>
<p>Усі виклики LLM Proxy → логуються (без plaintext):</p>
<ul>
<li>модель</li>
<li>тривалість</li>
<li>токени</li>
<li>cost</li>
<li>тип інструменту</li>
<li>fallback чи ні</li>
<li>error reason</li>
</ul>
<p>Метрики в Grafana:</p>
<ul>
<li>tokens/minute</li>
<li>токени per team</li>
<li>latency p95</li>
<li>fallback rate</li>
<li>provider availability</li>
</ul>
<hr />
<h2 id="21-safety-guardrails">21. Safety / Guardrails<a class="headerlink" href="#21-safety-guardrails" title="Permanent link">&para;</a></h2>
<p>LLM Proxy забороняє:</p>
<ul>
<li>генерувати шкідливі інструкції,</li>
<li>виконувати код,</li>
<li>описувати небезпечні дії,</li>
<li>обхід sandbox,</li>
<li>інструкції, спрямовані на капітальні зміни політик.</li>
</ul>
<hr />
<h2 id="22-example-complete-flow">22. Example Complete Flow<a class="headerlink" href="#22-example-complete-flow" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code><span class="n">sequenceDiagram</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">AG</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Agent</span><span class="w"> </span><span class="n">Runtime</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">GW</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Gateway</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">PDP</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">LP</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">LLM</span><span class="w"> </span><span class="n">Proxy</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">MR</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Router</span><span class="w"> </span><span class="n">Engine</span>
<span class="w">    </span><span class="n">participant</span><span class="w"> </span><span class="n">PV</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">Provider</span>

<span class="w">    </span><span class="n">AG</span><span class="o">-&gt;&gt;</span><span class="n">GW</span><span class="p">:</span><span class="w"> </span><span class="n">LLM</span><span class="w"> </span><span class="n">request</span>
<span class="w">    </span><span class="n">GW</span><span class="o">-&gt;&gt;</span><span class="n">PDP</span><span class="p">:</span><span class="w"> </span><span class="n">authorize</span><span class="w"> </span><span class="k">tool</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span>
<span class="w">    </span><span class="n">PDP</span><span class="o">--&gt;&gt;</span><span class="n">GW</span><span class="p">:</span><span class="w"> </span><span class="n">allow</span>
<span class="w">    </span><span class="n">GW</span><span class="o">-&gt;&gt;</span><span class="n">LP</span><span class="p">:</span><span class="w"> </span><span class="n">forward</span>
<span class="w">    </span><span class="n">LP</span><span class="o">-&gt;&gt;</span><span class="n">MR</span><span class="p">:</span><span class="w"> </span><span class="n">route</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">auto</span><span class="p">)</span>
<span class="w">    </span><span class="n">MR</span><span class="o">--&gt;&gt;</span><span class="n">LP</span><span class="p">:</span><span class="w"> </span><span class="n">gpt</span><span class="o">-</span><span class="mi">4</span><span class="n">o</span><span class="o">-</span><span class="n">mini</span>
<span class="w">    </span><span class="n">LP</span><span class="o">-&gt;&gt;</span><span class="n">PV</span><span class="p">:</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">model</span>
<span class="w">    </span><span class="n">PV</span><span class="o">--&gt;&gt;</span><span class="n">LP</span><span class="p">:</span><span class="w"> </span><span class="n">response</span>
<span class="w">    </span><span class="n">LP</span><span class="o">-&gt;&gt;</span><span class="n">GW</span><span class="p">:</span><span class="w"> </span><span class="n">tokens</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">result</span>
<span class="w">    </span><span class="n">GW</span><span class="o">-&gt;&gt;</span><span class="n">AG</span><span class="p">:</span><span class="w"> </span><span class="n">deliver</span>
</code></pre></div>

<hr />
<h2 id="23-integration-with-other-docs">23. Integration with Other Docs<a class="headerlink" href="#23-integration-with-other-docs" title="Permanent link">&para;</a></h2>
<p>Цей документ доповнює:</p>
<ul>
<li><code>11_llm_integration.md</code></li>
<li><code>44_usage_accounting_and_quota_engine.md</code></li>
<li><code>32_policy_service_PDP_design.md</code></li>
<li><code>36_agent_runtime_isolation_and_sandboxing.md</code></li>
<li><code>46_router_orchestrator_design.md</code></li>
</ul>
<hr />
<h2 id="24-cursor">24. Завдання для Cursor<a class="headerlink" href="#24-cursor" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><code>You are a senior backend engineer. Implement LLM Proxy &amp; Multi-Model Routing using:
- 45_llm_proxy_and_multimodel_routing.md
- 11_llm_integration.md
- 44_usage_accounting_and_quota_engine.md

Tasks:
1) Create LLM Proxy service architecture (Multi-Model Router Engine, Provider interfaces).
2) Implement Normalized Request Schema (unified format for all LLM requests).
3) Add Routing Modes (DIRECT, TIERED ROUTING, Specialized).
4) Implement Fallback Logic (timeout fallback, token compression, budget-based fallback).
5) Add Prompt Sanitization Layer (remove dangerous instructions, filter injections, jailbreak patterns).
6) Implement Confidential Mode (hide/redact plaintext, summary/embeddings only, disable vision).
7) Integrate with PDP (authorize tool.llm.invoke).
8) Add Token Counting (exact count, pre-count estimation, streaming accumulation).
9) Implement Cost Calculation (1T integration, model_price from Governance).
10) Add Multi-Model Orchestration (Router-Style Chains, Vision → Reasoning flow, Agents → Tools → LLM → Memory).
11) Implement Error Model (llm_timeout, llm_over_quota, llm_confidential_violation, llm_model_unavailable, llm_input_too_large, llm_safety_block).
12) Add Retry / Timeouts (per model type, retry logic).
13) Implement Model Selection Logic (auto routing based on request characteristics).
14) Add Local Model Constraints (confidential mode, cost override, offline mode).
15) Implement Autoscaling (worker pools, queue size, latency, error rate triggers).
16) Add Logging &amp; Monitoring (metrics, Grafana dashboards).
17) Implement Safety / Guardrails (block harmful instructions, code execution, dangerous actions).

Output:
- list of modified files
- diff
- summary
</code></pre></div>

<hr />
<h2 id="25-summary">25. Summary<a class="headerlink" href="#25-summary" title="Permanent link">&para;</a></h2>
<p>LLM Proxy забезпечує:</p>
<ul>
<li>єдиний інтерфейс до всіх моделей,</li>
<li>нормалізацію API,</li>
<li>безпеку promptів,</li>
<li>конфіденційний режим,</li>
<li>розумне маршрутування,</li>
<li>fallback,</li>
<li>облік токенів,</li>
<li>прогнозовану вартість,</li>
<li>масштабованість,</li>
<li>можливість multi-step orchestration,</li>
<li>захист від зловживань.</li>
</ul>
<p>Це — <strong>центральний обчислювальний шар всієї системи DAARION OS</strong>.</p>
<hr />
<p><strong>Версія:</strong> 1.0<br />
<strong>Останнє оновлення:</strong> 2024-11-14</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.instant", "content.code.copy"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.3220b9d7.min.js"></script>
      
    
  </body>
</html>