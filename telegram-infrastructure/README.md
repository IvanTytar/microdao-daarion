# Telegram Infrastructure

–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —Å—Ç–µ–∫ –¥–ª—è —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó Telegram-–±–æ—Ç—ñ–≤ –∑ —Å–∏—Å—Ç–µ–º–æ—é –∞–≥–µ–Ω—Ç—ñ–≤ DAGI/microDAO.

## üèóÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

–¶–µ–π —Å—Ç–µ–∫ —Å–∫–ª–∞–¥–∞—î—Ç—å—Å—è –∑ —Ç—Ä—å–æ—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤:

### 1. **telegram-bot-api** (Local Telegram Bot API)
- –û—Ñ—ñ—Ü—ñ–π–Ω–∏–π Local Telegram Bot API –≤—ñ–¥ Telegram
- –ü—Ä–∞—Ü—é—î –≤ —Ä–µ–∂–∏–º—ñ `--local` (HTTP only, –±–µ–∑ SSL)
- –î–æ—Å—Ç—É–ø–Ω–∏–π —Ç—ñ–ª—å–∫–∏ –Ω–∞ `127.0.0.1:8081` (–Ω–µ –ø—É–±–ª—ñ—á–Ω–∏–π)
- –î–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Bot API –±–µ–∑ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ Telegram —Å–µ—Ä–≤–µ—Ä—ñ–≤

### 2. **nats** (Message Bus)
- NATS —è–∫ —à–∏–Ω–∞ –ø–æ–¥—ñ–π –º—ñ–∂ —Å–µ—Ä–≤—ñ—Å–∞–º–∏
- –ü—Ä–æ—Å—Ç–∏–π —Ä–µ–∂–∏–º –±–µ–∑ –∫–ª–∞—Å—Ç–µ—Ä–∞
- –î–æ—Å—Ç—É–ø–Ω–∏–π –Ω–∞ `127.0.0.1:4222`

### 3. **telegram-gateway** (Python FastAPI)
- –ú—ñ—Å—Ç –º—ñ–∂ Telegram Bot API —ñ NATS
- –ë–∞–∑–æ–≤–∏–π FastAPI —Å–µ—Ä–≤—ñ—Å –∑ `/healthz` endpoint
- –ë—É–¥–µ —Ä–æ–∑—à–∏—Ä–µ–Ω–∏–π —á–µ—Ä–µ–∑ Cursor –¥–ª—è:
  - –ß–∏—Ç–∞–Ω–Ω—è –∞–ø–¥–µ–π—Ç—ñ–≤ –∑ Telegram
  - –ü—É–±–ª—ñ–∫–∞—Ü—ñ—ó –ø–æ–¥—ñ–π —É NATS
  - –ü—Ä–∏–π–æ–º—É HTTP –∫–æ–º–∞–Ω–¥ –≤—ñ–¥ —ñ–Ω—à–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤

## üìã –ü–µ—Ä–µ–¥—É–º–æ–≤–∏

- Docker + Docker Compose
- Telegram API credentials (API ID, API Hash) –∑ https://my.telegram.org/apps
- –î–æ–º–µ–Ω, —â–æ –≤–∫–∞–∑—É—î –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –º–∞–π–±—É—Ç–Ω—å–æ–≥–æ HTTPS)

## üöÄ –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç

### 1. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞

–°—Ç–≤–æ—Ä—ñ—Ç—å `.env` —Ñ–∞–π–ª —É –∫–æ—Ä–µ–Ω–µ–≤—ñ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó:

```bash
cp .env.example .env
```

–ó–∞–ø–æ–≤–Ω—ñ—Ç—å `.env` –≤–∞—à–∏–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏:

```env
TELEGRAM_API_ID=YOUR_API_ID
TELEGRAM_API_HASH=YOUR_API_HASH
GATEWAY_DOMAIN=gateway.daarion.city
```

### 2. –ó–∞–ø—É—Å–∫ —Å—Ç–µ–∫—É

```bash
docker compose up -d
```

### 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —â–æ –≤—Å—ñ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ –∑–∞–ø—É—â–µ–Ω—ñ:

```bash
docker compose ps
```

–û—á—ñ–∫—É–≤–∞–Ω–∏–π –≤–∏–≤—ñ–¥:
```
NAME                 STATUS    PORTS
telegram-bot-api     running   127.0.0.1:8081->8081/tcp
nats                 running   127.0.0.1:4222->4222/tcp
telegram-gateway     running   127.0.0.1:8000->8000/tcp
```

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ telegram-gateway

```bash
curl http://127.0.0.1:8000/healthz
```

–û—á—ñ–∫—É–≤–∞–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å:
```json
{
  "status": "ok",
  "service": "telegram-gateway",
  "telegram_api": "http://telegram-bot-api:8081",
  "nats": "nats://nats:4222"
}
```

### 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Local Telegram Bot API

–ó–∞–º—ñ–Ω—ñ—Ç—å `<YOUR_BOT_TOKEN>` –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω–∏–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞:

```bash
curl http://127.0.0.1:8081/bot<YOUR_BOT_TOKEN>/getMe
```

–û—á—ñ–∫—É–≤–∞–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å (JSON –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –±–æ—Ç–∞):
```json
{
  "ok": true,
  "result": {
    "id": 123456789,
    "is_bot": true,
    "first_name": "YourBot",
    "username": "your_bot"
  }
}
```

### 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ NATS

```bash
docker logs nats
```

–ú–∞—î –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ —É—Å–ø—ñ—à–Ω–∏–π –∑–∞–ø—É—Å–∫ NATS —Å–µ—Ä–≤–µ—Ä–∞.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—î–∫—Ç—É

```
telegram-infrastructure/
‚îú‚îÄ‚îÄ docker-compose.yml          # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Docker Compose
‚îú‚îÄ‚îÄ .env                        # –ó–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ (–Ω–µ –≤ git)
‚îú‚îÄ‚îÄ .env.example               # –ü—Ä–∏–∫–ª–∞–¥ –∑–º—ñ–Ω–Ω–∏—Ö
‚îú‚îÄ‚îÄ README.md                   # –¶—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è
‚îú‚îÄ‚îÄ data/                       # –î–∞–Ω—ñ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è)
‚îÇ   ‚îî‚îÄ‚îÄ telegram-bot-api/      # –î–∞–Ω—ñ Local Telegram Bot API
‚îî‚îÄ‚îÄ telegram-gateway/           # Telegram Gateway —Å–µ—Ä–≤—ñ—Å
    ‚îú‚îÄ‚îÄ Dockerfile
    ‚îú‚îÄ‚îÄ requirements.txt
    ‚îî‚îÄ‚îÄ app/
        ‚îú‚îÄ‚îÄ __init__.py
        ‚îî‚îÄ‚îÄ main.py            # FastAPI –¥–æ–¥–∞—Ç–æ–∫
```

## üîí –ë–µ–∑–ø–µ–∫–∞

- **telegram-bot-api** –¥–æ—Å—Ç—É–ø–Ω–∏–π —Ç—ñ–ª—å–∫–∏ –Ω–∞ localhost (`127.0.0.1:8081`)
- **nats** –¥–æ—Å—Ç—É–ø–Ω–∏–π —Ç—ñ–ª—å–∫–∏ –Ω–∞ localhost (`127.0.0.1:4222`)
- **telegram-gateway** –¥–æ—Å—Ç—É–ø–Ω–∏–π —Ç—ñ–ª—å–∫–∏ –Ω–∞ localhost (`127.0.0.1:8000`)
- –î–ª—è –ø—É–±–ª—ñ—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É –¥–æ–¥–∞–π—Ç–µ reverse proxy (Caddy/Traefik/nginx) –∑ HTTPS

## üîÑ –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è

### –ó—É–ø–∏–Ω–∫–∞ —Å–µ—Ä–≤—ñ—Å—ñ–≤

```bash
docker compose down
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤—ñ—Å—É

```bash
docker compose restart telegram-gateway
```

### –ü–µ—Ä–µ–≥–ª—è–¥ –ª–æ–≥—ñ–≤

```bash
# –í—Å—ñ —Å–µ—Ä–≤—ñ—Å–∏
docker compose logs -f

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —Å–µ—Ä–≤—ñ—Å
docker compose logs -f telegram-gateway
```

### Rebuild –ø—ñ—Å–ª—è –∑–º—ñ–Ω –∫–æ–¥—É

```bash
docker compose up -d --build telegram-gateway
```

## üìù –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

–ü—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–∞—Ü—é—î, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ **Cursor** –¥–ª—è —Ä–æ–∑—Ä–æ–±–∫–∏ –ª–æ–≥—ñ–∫–∏ `telegram-gateway`:

1. **–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è aiogram** ‚Äî –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ Telegram Bot API
2. **NATS publisher** ‚Äî –ø—É–±–ª—ñ–∫–∞—Ü—ñ—è –ø–æ–¥—ñ–π —É NATS
3. **Webhook endpoints** ‚Äî –ø—Ä–∏–π–æ–º –∫–æ–º–∞–Ω–¥ –≤—ñ–¥ —ñ–Ω—à–∏—Ö —Å–µ—Ä–≤—ñ—Å—ñ–≤
4. **Message routing** ‚Äî –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –º—ñ–∂ –∞–≥–µ–Ω—Ç–∞–º–∏

## üêõ Troubleshooting

### –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ –Ω–µ –∑–∞–ø—É—Å–∫–∞—é—Ç—å—Å—è

```bash
docker compose logs telegram-bot-api
```

### –ü–æ—Ä—Ç–∏ –∑–∞–π–Ω—è—Ç—ñ

–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –ø–æ—Ä—Ç–∏ 8081, 4222, 8000 –≤—ñ–ª—å–Ω—ñ:

```bash
lsof -i :8081
lsof -i :4222
lsof -i :8000
```

### –ü—Ä–æ–±–ª–µ–º–∏ –∑ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø—É

```bash
chmod -R 755 data/
```

## üìö –ü–æ—Å–∏–ª–∞–Ω–Ω—è

- [Local Telegram Bot API](https://github.com/tdlib/telegram-bot-api)
- [NATS](https://nats.io/)
- [FastAPI](https://fastapi.tiangolo.com/)
- [aiogram](https://docs.aiogram.dev/) (–¥–ª—è –º–∞–π–±—É—Ç–Ω—å–æ—ó —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó)
